<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multipage - Academic Template</title>

    <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Playfair+Display&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="./static/css/bulma.min.css">
    <link rel="stylesheet" href="./static/css/bulma-carousel.min.css">
    <link rel="stylesheet" href="./static/css/bulma-slider.min.css">
    <link rel="stylesheet" href="./static/css/fontawesome.all.min.css">
    <link rel="stylesheet" href="./static/css/index.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script defer src="./static/js/fontawesome.all.min.js"></script>
    <script src="./static/js/bulma-carousel.min.js"></script>
    <script src="./static/js/bulma-slider.min.js"></script>
    <script src="./static/js/index.js"></script>
    <script src="./static/js/templates.js"></script>
    <script src="./static/js/plugins.js"></script>

    <style>
        /* å¹²æ‰ Bulma é»˜è®¤ç®­å¤´ */
        .navbar.is-primary .navbar-end .navbar-link::after,
        .navbar.is-primary .navbar-start .navbar-link::after {
            content: none !important;
            border: none !important;
        }
    </style>
</head>

<body>

    <div id="background-container"
        style="background-image:linear-gradient(rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.5)),url('./media/occupacy.jpg');background-size: cover; background-position: center;background-attachment: fixed;padding-top: 52px; padding-bottom: 20px; margin-top: -52px; width: 100vw; position: relative; min-height: 100vh;">
        <nav class="navbar is-primary">
            <div class="navbar-brand">
                <a class="navbar-item" href="#" id="navbar-home">
                    <strong id="navbar-title">Home</strong>
                </a>

                <a class="navbar-item dark-mode-toggle-mobile" href="#" id="dark-mode-toggle-mobile"
                    title="Toggle Dark Mode">
                    <i class="fas fa-moon"></i>
                </a>

                <a class="navbar-item layout-mode-toggle" href="#" id="layout-mode-toggle"
                    title="Switch to Single-page Mode">
                    <i class="fas fa-file-alt"></i>
                </a>

                <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="top-navbar">
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                </a>
            </div>

            <div id="top-navbar" class="navbar-menu">
                <div class="navbar-end">
                    <div class="navbar-item has-dropdown" id="language-dropdown">
                        <a class="navbar-link" id="navbar-language"><span id="lang-label">Language</span><i
                                class="fas fa-chevron-left lang-arrow"></i></a>
                        <div class="navbar-dropdown" id="language-dropdown-menu"></div>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container is-max-desktop" id="content-root" style="min-height: calc(100vh - 120px);">
            <!-- åŠ¨æ€å†…å®¹å®¹å™¨ -->
        </div>

        <footer class="footer" style="position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000;">
            <div class="container">
                <div class="columns is-centered">
                    <div class="column">
                        <div class="content has-text-centered">
                            <p id="footer-text">Edit by Joshua@2025.9.27</p>
                        </div>
                    </div>
                </div>
            </div>
        </footer>

        <button id="back-to-top" class="back-to-top" title="è¿”å›é¡¶éƒ¨">
            <i class="fas fa-chevron-up"></i>
        </button>
    </div>

</body>

<script>
    let currentLang = localStorage.getItem('lang') || 'en';
    let availableLanguages = ['en', 'zh', 'jp'];
    let metaConfig = null;

    async function loadMeta() {
        try {
            const res = await fetch(`data/meta.json`);
            metaConfig = await res.json();
            if (Array.isArray(metaConfig.availableLanguages)) {
                availableLanguages = metaConfig.availableLanguages;
            }
        } catch (e) { console.error('Failed to load meta.json', e); }
    }

    function applyMetaToNav(webContent) {
        if (!metaConfig || !Array.isArray(metaConfig.sections)) return;
        metaConfig.sections.forEach(sec => {
            const id = sec.id;
            const navId = `#navbar-${id.replace(/_/g, '-')}`;
            const link = document.querySelector(navId);
            if (link) {
                link.style.display = sec.enabled ? '' : 'none';
                if (webContent && sec.navLabelKey && webContent[sec.navLabelKey]) link.innerHTML = webContent[sec.navLabelKey];
            }
        });
    }

    function generateSocials(socials) {
        const box = document.querySelector('.icon-box');
        if (!box) return;
        box.innerHTML = '';
        (socials || []).forEach(s => {
            const a = document.createElement('a');
            a.href = s.url || '#';
            a.target = '_blank';
            const i = document.createElement('i');
            i.className = s.icon || 'fas fa-link';
            a.appendChild(i);
            box.appendChild(a);
        });
    }

    function getPageKey() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('page') || 'home';
    }

    async function loadWebContent(lang = currentLang) {
        const res = await fetch(`data/${lang}/web_content.json`);
        return await res.json();
    }

    function updateElement(selector, html) {
        if (html === undefined || html === null) return;
        const element = document.querySelector(selector);
        if (element) element.innerHTML = html;
    }

    function renderTextList(selector, texts) {
        const container = document.querySelector(selector);
        if (!container) return;
        container.innerHTML = '';
        if (!Array.isArray(texts)) return;
        texts.forEach((text, idx) => {
            const p = document.createElement('p');
            p.className = 'text-homepage-1';
            p.innerHTML = text;
            p.dataset.index = idx;
            container.appendChild(p);
        });
    }

    function generateLanguageButtons(webContent) {
        const langDropdown = document.querySelector('#language-dropdown');
        const wasOpen = langDropdown && langDropdown.classList.contains('is-active');
        const dropdown = document.querySelector('#language-dropdown-menu');
        dropdown.innerHTML = '';
        availableLanguages.forEach(lang => {
            const langKeyMap = { 'en': 'english', 'zh': 'chinese', 'jp': 'japanese' };
            const langKey = langKeyMap[lang];
            const langName = webContent[langKey] || lang;
            const button = document.createElement('a');
            button.className = 'navbar-item';
            button.onclick = (e) => { e.stopPropagation(); switchLanguage(lang); };
            button.innerHTML = langName;
            dropdown.appendChild(button);
        });
        // æ¢å¤åŸå…ˆå±•å¼€çŠ¶æ€ï¼ˆé¿å…PCç«¯åˆ‡æ¢è¯­è¨€åæ”¶èµ·ï¼‰
        if (langDropdown && wasOpen) {
            langDropdown.classList.add('is-active');
        }
    }

    function switchLanguage(lang) {
        localStorage.setItem('lang', lang);
        currentLang = lang;
        const dropdown = document.querySelector('#language-dropdown');
        const wasOpen = dropdown && dropdown.classList.contains('is-active');
        renderPage().then(() => {
            const dd = document.querySelector('#language-dropdown');
            if (dd && wasOpen) dd.classList.add('is-active');
        });
    }

    function goTo(page) {
        const url = new URL(window.location.href);
        url.searchParams.set('page', page);
        window.history.pushState({}, '', url.toString());
        renderPage();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function wireNavLinks() {
        const links = document.querySelectorAll('.navbar-item[href^="?page="]');
        links.forEach(a => {
            a.addEventListener('click', (e) => {
                e.preventDefault();
                const href = a.getAttribute('href');
                const m = /[?&]page=([^&#]+)/.exec(href);
                if (m && m[1]) goTo(m[1]);
            });
        });
    }

    function generateNavFromMeta(webContent) {
        if (!metaConfig || !Array.isArray(metaConfig.sections)) return;
        const navbarEnd = document.querySelector('.navbar-end');
        if (!navbarEnd) return;
        const items = Array.from(navbarEnd.querySelectorAll('.navbar-item'));
        items.forEach(el => { if (!el.closest('#language-dropdown')) el.remove(); });
        metaConfig.sections.forEach(sec => {
            if (!sec.enabled) return;
            const a = document.createElement('a');
            a.className = 'navbar-item';
            a.id = `navbar-${sec.id}`;
            a.href = `?page=${sec.id}`;
            const label = (webContent && sec.navLabelKey && webContent[sec.navLabelKey]) ? webContent[sec.navLabelKey] : sec.id;
            a.innerHTML = label;
            navbarEnd.insertBefore(a, document.getElementById('language-dropdown'));
        });
        wireNavLinks();
    }

    async function renderPage() {
        await loadMeta();
        // ç¡®ä¿ä½¿ç”¨æœ€æ–°è¯­è¨€
        currentLang = localStorage.getItem('lang') || currentLang || 'en';
        const page = getPageKey();
        const webContent = await loadWebContent(currentLang);

        generateNavFromMeta(webContent);
        updateElement('#navbar-title', webContent.navbar_title);
        updateElement('#navbar-home', webContent.navbar_home);
        updateElement('#navbar-about', webContent.navbar_about);
        updateElement('#navbar-news', webContent.navbar_news);
        updateElement('#navbar-publications', webContent.navbar_publications);
        updateElement('#navbar-projects', webContent.navbar_projects);
        updateElement('#navbar-blogs', webContent.navbar_blogs);
        updateElement('#navbar-academic-service', webContent.navbar_academic_service);
        // updateElement('#navbar-language', webContent.language);
        document.getElementById('lang-label').textContent = webContent.language;
        updateElement('#footer-text', webContent.footer);
        generateLanguageButtons(webContent);

        const root = document.getElementById('content-root');
        root.innerHTML = '';

        // åˆ‡æ¢å‰ï¼Œå…ˆæ¢å¤æ»šåŠ¨ï¼Œé¿å…ç¦ç”¨é—ç•™
        document.documentElement.classList.remove('mp-home-fixed');
        document.body.classList.remove('mp-home-fixed');

        if (page === 'home') {
            // é¦–é¡µåœ¨æ‰€æœ‰ç«¯ç¦ç”¨æ»šåŠ¨
            document.documentElement.classList.add('mp-home-fixed');
            document.body.classList.add('mp-home-fixed');
            const container = document.createElement('div');
            container.className = 'container has-text-centered';
            container.innerHTML = `
        <div style="display: flex; justify-content: center; align-items: center; height: 300px;">
          <div style="flex: 1; display: flex; justify-content: center; align-items: center;">
            <figure class="image is-128x128 is-inline-block" style="width: 200px; height: 200px; margin: 0;">
              <img class="is-rounded" src="./media/personal.jpg" alt="Avatar" style="width: 100%; height: 100%;">
            </figure>
          </div>
        </div>
        <h1 class="title is-size-3-tablet is-size-4-mobile" style="font-family: Futura;" id="main-title"></h1>
        <p class="subtitle is-size-4-tablet is-size-5-mobile" style="font-family: Brush Script MT;" id="main-subtitle"></p>
        <div class="icon-box">
          <a href="https://github.com/Phospheneser" target="_blank"><i class="fab fa-github"></i></a>
          <a href="https://scholar.google.com/citations?user=TSUlagkAAAAJ&hl=zh-CN" target="_blank"><i class="fas fa-graduation-cap"></i></a>
          <a href="https://x.com/PhospheneserXu" target="_blank"><i class="fab fa-twitter"></i></a>
          <a href="mailto:zxu24@m.fudan.edu.cn"><i class="fas fa-envelope"></i></a>
        </div>`;
            root.appendChild(container);
            updateElement('#main-title', webContent.title);
            updateElement('#main-subtitle', webContent.subtitle);
            if (metaConfig && metaConfig.home && metaConfig.home.avatar) {
                const avatar = container.querySelector('img.is-rounded');
                if (avatar) avatar.src = metaConfig.home.avatar;
            }
            if (metaConfig && Array.isArray(metaConfig.socials)) {
                generateSocials(metaConfig.socials);
            }
        } else if (page === 'about') {
            // å…¶ä»–é¡µé¢ä¿æŒæ»šåŠ¨å¼€å¯ï¼ˆå·²åœ¨å¼€å¤´å¤„ç†ï¼‰
            const container = document.createElement('div');
            container.innerHTML = `
        <section class="section" name="sec-intro">
          <div id="about">
            <h1 class="title is-3" id="about-title" style="margin-top: 60px;">ğŸ„ About Me</h1>
          </div>
          <div id="about-texts" class="about-texts"></div>
        </section>`;
            root.appendChild(container);
            updateElement('#about-title', webContent.about_title);
            renderTextList('#about-texts', webContent.about_texts);
        } else {
            // ä½¿ç”¨é…ç½®é©±åŠ¨çš„æ¸²æŸ“
            const section = metaConfig.sections.find(s => s.id === page);
            if (section && section.multiPage && section.multiPage.enabled) {
                const multiPageConfig = section.multiPage;
                let listData = [];

                // åŠ è½½æ•°æ®
                if (section.dataSource) {
                    const dataRes = await fetch(`data/${currentLang}/${section.dataSource}.json`);
                    const data = await dataRes.json();
                    listData = data[section.dataSource] || [];
                }

                // åˆ›å»ºå®¹å™¨
                const container = document.createElement('div');
                const sectionClass = page === 'blogs' ? 'blogs' : 'section';
                container.innerHTML = `
        <section class="${sectionClass}" name="sec-${page}">
          <div id="${page}" class="mp-section">
            <h1 class="title is-3" style="margin-bottom: 1ex; margin-top: 60px;" id="${page}-title"></h1>
            <div class="mp-controls" id="${page}-controls"></div>
            <div class="mp-list" id="${page}-content"></div>
          </div>
        </section>`;
                root.appendChild(container);

                // æ›´æ–°æ ‡é¢˜
                updateElement(`#${page}-title`, webContent[section.titleKey]);

                const sectionRoot = container.querySelector(`#${page}`);
                const contentDiv = sectionRoot.querySelector('.mp-list');
                if (!contentDiv) {
                    console.warn(`Missing content container for section ${page}`);
                    return;
                }

                // åº”ç”¨æ’ä»¶ï¼ˆå¤šé¡µæ¨¡å¼ï¼‰
                if (window.PluginRegistry && multiPageConfig.plugins) {
                    window.PluginRegistry.applyPlugins({
                        id: page,
                        plugins: multiPageConfig.plugins
                    }, sectionRoot, listData, webContent);
                }

                // æ¸²æŸ“å†…å®¹
                drawList(listData, section, contentDiv);
            }
        }
    }

    function drawList(list, section, contentDiv) {
        if (!contentDiv) return;
        contentDiv.innerHTML = '';
        const type = section.itemType;
        const templateName = (metaConfig && metaConfig.itemTypes && metaConfig.itemTypes[type] && metaConfig.itemTypes[type].template) || (type === 'news' ? 'list-inline' : 'paper-card');
        const renderer = (window.TemplateRegistry && window.TemplateRegistry.get(templateName));
        if (renderer) {
            renderer(list, section, contentDiv);
        }
    }

    function initializeLanguageDropdown() {
        const languageLink = document.querySelector('#navbar-language');
        const languageDropdown = document.querySelector('#language-dropdown');
        if (languageLink && languageDropdown) {
            // åˆå§‹ä¿æŒæ”¶èµ·
            languageDropdown.classList.remove('is-active');

            languageLink.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const willOpen = !languageDropdown.classList.contains('is-active');
                if (willOpen) {
                    languageDropdown.classList.remove('is-closing');
                    languageDropdown.classList.add('is-active');
                } else {
                    languageDropdown.classList.add('is-closing');
                    setTimeout(() => {
                        languageDropdown.classList.remove('is-active');
                        languageDropdown.classList.remove('is-closing');
                    }, 350);
                }
            });
            document.addEventListener('click', (e) => {
                if (!languageDropdown.contains(e.target) && languageDropdown.classList.contains('is-active')) {
                    languageDropdown.classList.add('is-closing');
                    setTimeout(() => {
                        languageDropdown.classList.remove('is-active');
                        languageDropdown.classList.remove('is-closing');
                    }, 350);
                }
            });
        }
    }

    function initializeLayoutMode() {
        const layoutModeToggle = document.getElementById('layout-mode-toggle');
        if (layoutModeToggle) {
            layoutModeToggle.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.setItem('layoutMode', 'single');
                window.location.href = 'index.html?scroll=top';
            });
        }
    }

    function initializeDarkMode() {
        const darkModeToggleMobile = document.getElementById('dark-mode-toggle-mobile');
        const body = document.body;
        const isDarkMode = localStorage.getItem('darkMode') === 'true';
        if (isDarkMode) {
            body.classList.add('dark-mode');
            if (darkModeToggleMobile) darkModeToggleMobile.innerHTML = '<i class="fas fa-sun"></i>';
        } else {
            if (darkModeToggleMobile) darkModeToggleMobile.innerHTML = '<i class="fas fa-moon"></i>';
        }
        function toggleDarkMode() {
            const isCurrentlyDark = body.classList.contains('dark-mode');
            const backgroundContainer = document.getElementById('background-container');
            if (isCurrentlyDark) {
                body.classList.remove('dark-mode');
                localStorage.setItem('darkMode', 'false');
                backgroundContainer.style.backgroundImage = "linear-gradient(rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.5)),url('./media/occupacy.jpg')";
                if (darkModeToggleMobile) darkModeToggleMobile.innerHTML = '<i class="fas fa-moon"></i>';
            } else {
                body.classList.add('dark-mode');
                localStorage.setItem('darkMode', 'true');
                const darkImage = new Image();
                darkImage.onload = function () {
                    backgroundContainer.style.backgroundImage = "linear-gradient(rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.5)),url('./media/occupacy_dark.jpg')";
                };
                darkImage.onerror = function () { };
                darkImage.src = './media/occupacy_dark.jpg';
                if (darkModeToggleMobile) darkModeToggleMobile.innerHTML = '<i class="fas fa-sun"></i>';
            }
        }

        if (darkModeToggleMobile) {
            darkModeToggleMobile.addEventListener('click', (e) => {
                e.preventDefault();
                toggleDarkMode();
            });
        }
    }

    function initializeBackToTop() {
        const backToTopButton = document.getElementById('back-to-top');
        window.addEventListener('scroll', () => {
            if (window.pageYOffset > 300) backToTopButton.classList.add('show'); else backToTopButton.classList.remove('show');
        });
        backToTopButton.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }

    function initializeHamburgerAutoClose() {
        const burger = document.querySelector('.navbar-burger');
        const menu = document.querySelector('.navbar-menu');
        if (!burger || !menu) return;
        document.addEventListener('click', (e) => {
            if (!menu.contains(e.target) && menu.classList.contains('is-active')) {
                menu.classList.add('is-closing');
                setTimeout(() => {
                    menu.classList.remove('is-active');
                    menu.classList.remove('is-closing');
                    burger.classList.remove('is-active');
                }, 100);
            }
        });
    }
    function initializeHomeLink() {
        const home = document.getElementById('navbar-home');
        if (home) {
            home.addEventListener('click', (e) => {
                e.preventDefault();
                goTo('home');
            });
        }
    }

    window.addEventListener('popstate', () => renderPage());

    document.addEventListener('DOMContentLoaded', () => {
        // å¤šé¡µå®¹å™¨
        renderPage();
        // ç›‘å¬çª—å£å°ºå¯¸å˜åŒ–ï¼šå…ˆæ¢å¤ï¼Œå†æŒ‰éœ€ç¦ç”¨
        window.addEventListener('resize', () => {
            const page = getPageKey();
            document.documentElement.classList.remove('mp-home-fixed');
            document.body.classList.remove('mp-home-fixed');
            if (page === 'home') {
                document.documentElement.classList.add('mp-home-fixed');
                document.body.classList.add('mp-home-fixed');
            }
        });
        initializeLanguageDropdown();
        initializeLayoutMode();
        initializeDarkMode();
        initializeBackToTop();
        initializeHomeLink();
        wireNavLinks();
        initializeHamburgerAutoClose();
    });
</script>

</html>
