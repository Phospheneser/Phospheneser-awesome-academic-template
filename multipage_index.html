<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multipage - Academic Template</title>
    <meta name="author" content="Phospheneser">
    <meta name="copyright" content="Â© 2024 Phospheneser. All rights reserved.">

    <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Playfair+Display&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="./static/css/bulma.min.css">
    <link rel="stylesheet" href="./static/css/bulma-carousel.min.css">
    <link rel="stylesheet" href="./static/css/bulma-slider.min.css">
    <link rel="stylesheet" href="./static/css/fontawesome.all.min.css">
    <link rel="stylesheet" href="./static/css/index.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script defer src="./static/js/fontawesome.all.min.js"></script>
    <script src="./static/js/bulma-carousel.min.js"></script>
    <script src="./static/js/bulma-slider.min.js"></script>
    <script src="./static/js/index.js"></script>
    <script src="./static/js/templates.js"></script>
    <script src="./static/js/plugins.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.0.6/wordcloud2.min.js"></script>
    <script src="https://www.goat1000.com/tagcanvas.min.js"></script>

    <style>
        /* å¹²æŽ‰ Bulma é»˜è®¤ç®­å¤´ */
        .navbar.is-primary .navbar-end .navbar-link::after,
        .navbar.is-primary .navbar-start .navbar-link::after {
            content: none !important;
            border: none !important;
        }
    </style>
</head>

<body>

    <div id="background-container"
        style="background-image:linear-gradient(rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.5)),url('./media/occupacy.jpg');background-size: cover; background-position: center;background-attachment: fixed;padding-top: 52px; padding-bottom: 20px; margin-top: -52px; width: 100vw; position: relative; min-height: 100vh;">
        <nav class="navbar is-primary">
            <div class="navbar-brand">
                <a class="navbar-item" href="#" id="navbar-home">
                    <strong id="navbar-title">Home</strong>
                </a>

                <a class="navbar-item dark-mode-toggle-mobile" href="#" id="dark-mode-toggle-mobile"
                    title="Toggle Dark Mode">
                    <i class="fas fa-moon"></i>
                </a>

                <a class="navbar-item layout-mode-toggle" href="#" id="layout-mode-toggle"
                    title="Switch to Single-page Mode">
                    <i class="fas fa-file-alt"></i>
                </a>

                <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="top-navbar">
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                </a>
            </div>

            <div id="top-navbar" class="navbar-menu">
                <div class="navbar-end">
                    <div class="navbar-item has-dropdown" id="language-dropdown">
                        <a class="navbar-link" id="navbar-language"><span id="lang-label">Language</span><i
                                class="fas fa-chevron-left lang-arrow"></i></a>
                        <div class="navbar-dropdown" id="language-dropdown-menu"></div>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container is-max-desktop" id="content-root" style="min-height: calc(100vh - 120px);">
            <!-- åŠ¨æ€å†…å®¹å®¹å™¨ -->
        </div>

        <footer class="footer" style="position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000;">
            <div class="container">
                <div class="columns is-centered">
                    <div class="column">
                        <div class="content has-text-centered">
                            <p id="footer-text">Â© 2024 Phospheneser. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </footer>

        <button id="back-to-top" class="back-to-top" title="è¿”å›žé¡¶éƒ¨">
            <i class="fas fa-chevron-up"></i>
        </button>
    </div>

</body>

<script>
    let currentLang = localStorage.getItem('lang') || 'en';
    let availableLanguages = ['en', 'zh', 'jp'];
    let metaConfig = null;
    const BLOG_LABELS = {
        readMore: {
            en: 'Read more',
            zh: 'é˜…è¯»å…¨æ–‡',
            jp: 'ç¶šãã‚’èª­ã‚€'
        },
        archive: {
            en: 'View all posts',
            zh: 'æŸ¥çœ‹å…¨éƒ¨æ–‡ç« ',
            jp: 'ã™ã¹ã¦ã®è¨˜äº‹ã‚’è¦‹ã‚‹'
        }
    };

    async function loadMeta() {
        try {
            const res = await fetch(`data/meta.json`);
            metaConfig = await res.json();
            if (Array.isArray(metaConfig.availableLanguages)) {
                availableLanguages = metaConfig.availableLanguages;
            }
        } catch (e) { console.error('Failed to load meta.json', e); }
    }

    function generateSocials(socials) {
        const box = document.querySelector('.icon-box');
        if (!box) return;
        box.innerHTML = '';
        (socials || []).forEach(s => {
            const a = document.createElement('a');
            a.href = s.url || '#';
            a.target = '_blank';
            const i = document.createElement('i');
            i.className = s.icon || 'fas fa-link';
            a.appendChild(i);
            box.appendChild(a);
        });
    }

    function getPageKey() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('page') || 'home';
    }

    async function loadWebContent(lang = currentLang) {
        const res = await fetch(`data/${lang}/web_content.json`);
        return await res.json();
    }

    function updateElement(selector, html) {
        if (html === undefined || html === null) return;
        const element = document.querySelector(selector);
        if (element) element.innerHTML = html;
    }

    function renderTextList(selector, texts) {
        const container = document.querySelector(selector);
        if (!container) return;
        container.innerHTML = '';
        if (!Array.isArray(texts)) return;
        texts.forEach((text, idx) => {
            const p = document.createElement('p');
            p.className = 'text-homepage-1';
            p.innerHTML = text;
            p.dataset.index = idx;
            container.appendChild(p);
        });
    }

    async function loadSectionDataMap(lang) {
        const map = {};
        if (!metaConfig || !Array.isArray(metaConfig.sections)) return map;
        const tasks = metaConfig.sections.map(async (section) => {
            if (!section.enabled) return;
            const source = section.dataSource || section.id;
            try {
                const res = await fetch(`data/${lang}/${source}.json`);
                if (!res.ok) return;
                const data = await res.json();
                map[section.id] = data;
            } catch (err) {
                console.error(`Failed to load section data for ${section.id}`, err);
            }
        });
        await Promise.all(tasks);
        return map;
    }

    function applyBackground(pageId) {
        const container = document.getElementById('background-container');
        if (!container || !metaConfig) return;

        const darkMode = document.body.classList.contains('dark-mode');
        const backgrounds = metaConfig.backgrounds || {};
        const section = metaConfig.sections ? metaConfig.sections.find(s => s.id === pageId) : null;
        let key = (section && section.background) || (pageId === 'home' ? (backgrounds.home ? 'home' : 'default') : null);
        if (!key || !backgrounds[key]) key = 'default';
        const defaultBg = backgrounds.default || {};
        const bgConfig = backgrounds[key] || {};
        const lightImage = bgConfig.light || defaultBg.light || './media/occupacy.jpg';
        const darkImage = bgConfig.dark || defaultBg.dark || '';

        let background;
        if (darkMode) {
            if (darkImage) {
                background = `linear-gradient(rgba(0, 0, 0, 0.35), rgba(0, 0, 0, 0.35)),url('${darkImage}')`;
            } else {
                background = `linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)),url('${lightImage}')`;
            }
        } else {
            background = `linear-gradient(rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.5)),url('${lightImage}')`;
        }

        container.style.backgroundImage = background;
    }

    async function loadHomeWidgets() {
        try {
            const [cardsRes, wordcloudRes] = await Promise.all([
                fetch(`data/${currentLang}/cards.json`),
                fetch(`data/${currentLang}/wordcloud.json`)
            ]);

            const cardsData = cardsRes.ok ? await cardsRes.json() : { cards: [] };
            const wordcloudData = wordcloudRes.ok ? await wordcloudRes.json() : { wordcloud: [] };

            generateCards(cardsData.cards || []);
            generateWordCloud(wordcloudData.wordcloud || []);
            initializeCardSlider();
        } catch (err) {
            console.error('Failed to load home widgets:', err);
        }
    }

    function generateCards(cardsList) {
        const cardContainer = document.querySelector('.card-container');
        if (!cardContainer) return;

        cardContainer.querySelectorAll('.card').forEach(card => card.remove());

        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        if (!Array.isArray(cardsList) || cardsList.length === 0) {
            if (prevBtn) prevBtn.style.display = 'none';
            if (nextBtn) nextBtn.style.display = 'none';
            return;
        }

        if (prevBtn) prevBtn.style.display = '';
        if (nextBtn) nextBtn.style.display = '';

        const insertBeforeNode = nextBtn || null;
        cardsList.slice(0, 5).forEach(card => {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'card';
            cardDiv.innerHTML = `
      <div class="card-title">${card.title || ''}</div>
      <div class="card-description">${card.description || ''}</div>`;
            cardContainer.insertBefore(cardDiv, insertBeforeNode);
        });
    }

    function initializeCardSlider() {
        const cardContainer = document.querySelector('.card-container');
        if (!cardContainer) return;

        const cards = Array.from(cardContainer.querySelectorAll('.card'));
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        if (!cards.length) {
            if (prevBtn) prevBtn.style.display = 'none';
            if (nextBtn) nextBtn.style.display = 'none';
            return;
        }

        let currentIndex = Math.floor(Math.random() * cards.length);
        if (!Number.isFinite(currentIndex)) currentIndex = 0;

        function showCard(index) {
            cards.forEach((card, i) => {
                if (i === index) card.classList.add('active'); else card.classList.remove('active');
            });
        }

        const showPrev = () => {
            currentIndex = (currentIndex - 1 + cards.length) % cards.length;
            showCard(currentIndex);
        };

        const showNext = () => {
            currentIndex = (currentIndex + 1) % cards.length;
            showCard(currentIndex);
        };

        if (prevBtn) {
            prevBtn.style.display = '';
            prevBtn.onclick = showPrev;
        }

        if (nextBtn) {
            nextBtn.style.display = '';
            nextBtn.onclick = showNext;
        }

        if (window.__cardSliderTimer) {
            clearInterval(window.__cardSliderTimer);
        }
        window.__cardSliderTimer = setInterval(showNext, 5000);

        showCard(currentIndex);
    }

    function generateWordCloud(wordcloudList) {
        const tagsContainer = document.querySelector('#tags');
        const canvas = document.getElementById('word-cloud');
        if (!tagsContainer || !canvas) return;

        tagsContainer.innerHTML = '';

        if (!Array.isArray(wordcloudList) || wordcloudList.length === 0) {
            canvas.style.display = 'none';
            return;
        }

        canvas.style.display = '';

        wordcloudList.forEach(item => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = '#';
            if (item && item.title) a.title = item.title;
            a.textContent = item && item.text ? item.text : '';
            li.appendChild(a);
            tagsContainer.appendChild(li);
        });

        try {
            if (typeof TagCanvas !== 'undefined') {
                if (typeof TagCanvas.Delete === 'function') {
                    try { TagCanvas.Delete('word-cloud'); } catch (e) { /* ignore */ }
                }
                TagCanvas.Start('word-cloud', 'tags', {
                    textColour: '#FFFFFF',
                    outlineColour: 'rgba(255, 255, 255, 0.5)',
                    reverse: true,
                    depth: 0.8,
                    maxSpeed: 0.01,
                    textFont: 'Papyrus, Arial, sans-serif',
                    textHeight: 20,
                    shuffleTags: true,
                    initial: [0.3, 0.3],
                    decel: 0.98,
                    dragControl: true,
                    weight: true,
                    shape: 'spiral'
                });
            }
        } catch (err) {
            console.error('Failed to initialize word cloud:', err);
        }
    }

    function generateLanguageButtons(webContent) {
        const langDropdown = document.querySelector('#language-dropdown');
        const wasOpen = langDropdown && langDropdown.classList.contains('is-active');
        const dropdown = document.querySelector('#language-dropdown-menu');
        dropdown.innerHTML = '';
        availableLanguages.forEach(lang => {
            const langName = (metaConfig && metaConfig.languageLabels && metaConfig.languageLabels[lang]) || lang;
            const button = document.createElement('a');
            button.className = 'navbar-item';
            button.onclick = (e) => { e.stopPropagation(); switchLanguage(lang); };
            button.innerHTML = langName;
            dropdown.appendChild(button);
        });
        // æ¢å¤åŽŸå…ˆå±•å¼€çŠ¶æ€ï¼ˆé¿å…PCç«¯åˆ‡æ¢è¯­è¨€åŽæ”¶èµ·ï¼‰
        if (langDropdown && wasOpen) {
            langDropdown.classList.add('is-active');
        }
    }

    function switchLanguage(lang) {
        localStorage.setItem('lang', lang);
        currentLang = lang;
        const dropdown = document.querySelector('#language-dropdown');
        const wasOpen = dropdown && dropdown.classList.contains('is-active');
        renderPage().then(() => {
            const dd = document.querySelector('#language-dropdown');
            if (dd && wasOpen) dd.classList.add('is-active');
            applyBackground(getPageKey());
        });
    }

    function goTo(page) {
        const url = new URL(window.location.href);
        url.searchParams.set('page', page);
        window.history.pushState({}, '', url.toString());
        renderPage().then(() => applyBackground(getPageKey()));
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function wireNavLinks() {
        const links = document.querySelectorAll('.navbar-item[href^="?page="]');
        links.forEach(a => {
            a.addEventListener('click', (e) => {
                e.preventDefault();
                const href = a.getAttribute('href');
                const m = /[?&]page=([^&#]+)/.exec(href);
                if (m && m[1]) goTo(m[1]);
            });
        });
    }

    function generateNavFromMeta(sectionDataMap) {
        if (!metaConfig || !Array.isArray(metaConfig.sections)) return;
        const navbarEnd = document.querySelector('.navbar-end');
        if (!navbarEnd) return;
        const items = Array.from(navbarEnd.querySelectorAll('.navbar-item'));
        items.forEach(el => { if (!el.closest('#language-dropdown')) el.remove(); });
        metaConfig.sections.forEach(sec => {
            if (!sec.enabled) return;
            const a = document.createElement('a');
            a.className = 'navbar-item';
            a.id = `navbar-${sec.id}`;
            a.href = `?page=${sec.id}`;
            const label = (sectionDataMap && sectionDataMap[sec.id] && sectionDataMap[sec.id].nav_label) ? sectionDataMap[sec.id].nav_label : sec.id;
            a.innerHTML = label;
            navbarEnd.insertBefore(a, document.getElementById('language-dropdown'));
        });
        wireNavLinks();
    }

    async function renderPage() {
        await loadMeta();
        currentLang = localStorage.getItem('lang') || currentLang || 'en';
        const page = getPageKey();

        const [webContent, sectionDataMap] = await Promise.all([
            loadWebContent(currentLang),
            loadSectionDataMap(currentLang)
        ]);

        generateNavFromMeta(sectionDataMap);
        updateElement('#navbar-title', webContent.navbar_title);
        updateElement('#navbar-home', webContent.navbar_home);
        document.getElementById('lang-label').textContent = webContent.language;
        updateElement('#footer-text', webContent.footer);
        generateLanguageButtons(webContent);

        const root = document.getElementById('content-root');
        root.innerHTML = '';

        if (page === 'home') {
            const container = document.createElement('div');
            container.className = 'container has-text-centered';
            container.innerHTML = `
        <div class="mp-home-hero">
          <div class="mp-home-cards">
            <div class="card-container">
              <button class="arrow-btn arrow-left" id="prev-btn">
                <i class="fas fa-arrow-left"></i>
              </button>
              <button class="arrow-btn arrow-right" id="next-btn">
                <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>

          <div class="mp-home-avatar">
            <figure class="image is-128x128 is-inline-block">
              <img class="is-rounded" src="./media/personal.jpg" alt="Avatar" style="width: 100%; height: 100%;">
            </figure>
          </div>

          <div class="mp-home-cloud">
            <div id="canvas-container">
              <canvas id="word-cloud" width="400" height="300"></canvas>
              <ul id="tags"></ul>
            </div>
          </div>
        </div>
        <div class="mp-home-meta">
          <h1 class="title is-size-3-tablet is-size-4-mobile" style="font-family: Futura;" id="main-title"></h1>
          <p class="subtitle is-size-4-tablet is-size-5-mobile" style="font-family: Brush Script MT;" id="main-subtitle"></p>
          <div class="icon-box">
            <a href="https://github.com/Phospheneser" target="_blank"><i class="fab fa-github"></i></a>
            <a href="https://scholar.google.com/citations?user=TSUlagkAAAAJ&hl=zh-CN" target="_blank"><i class="fas fa-graduation-cap"></i></a>
            <a href="https://x.com/PhospheneserXu" target="_blank"><i class="fab fa-twitter"></i></a>
            <a href="mailto:zxu24@m.fudan.edu.cn"><i class="fas fa-envelope"></i></a>
          </div>
        </div>`;
            root.appendChild(container);
            updateElement('#main-title', webContent.title);
            updateElement('#main-subtitle', webContent.subtitle);
            if (metaConfig && metaConfig.home && metaConfig.home.avatar) {
                const avatar = container.querySelector('img.is-rounded');
                if (avatar) avatar.src = metaConfig.home.avatar;
            }
            if (metaConfig && Array.isArray(metaConfig.socials)) {
                generateSocials(metaConfig.socials);
            }
            await loadHomeWidgets();
            applyBackground('home');
            return;
        }

        if (page === 'about') {
            const aboutData = sectionDataMap['about'] || {};
            const container = document.createElement('div');
            container.innerHTML = `
        <section class="section" name="sec-intro">
          <div id="about">
            <h1 class="title is-3" id="about-title" style="margin-top: 60px;">ðŸŽ„ About Me</h1>
          </div>
          <div id="about-texts" class="about-texts"></div>
        </section>`;
            root.appendChild(container);
            updateElement('#about-title', aboutData.title || 'About');
            renderTextList('#about-texts', aboutData.texts || aboutData.paragraphs || []);
            applyBackground('about');
            return;
        }

        const section = metaConfig.sections.find(s => s.id === page);
        if (!section || !section.multiPage || !section.multiPage.enabled) return;
        const data = sectionDataMap[page] || {};
        const multiPageConfig = section.multiPage;
        let listData = [];
        if (section.dataSource && Array.isArray(data[section.dataSource])) {
            listData = data[section.dataSource];
        } else if (Array.isArray(data.items)) {
            listData = data.items;
        }

        const container = document.createElement('div');
        container.innerHTML = `
        <section class="section" name="sec-${page}">
          <div id="${page}" class="mp-section">
            <h1 class="title is-3" style="margin-bottom: 1ex; margin-top: 60px;" id="${page}-title"></h1>
            <div class="mp-controls" id="${page}-controls"></div>
            <div class="mp-list about-texts" id="${page}-content"></div>
          </div>
        </section>`;
        root.appendChild(container);

        const sectionRoot = container.querySelector(`#${page}`);
        const contentDiv = sectionRoot.querySelector('.mp-list');
        updateElement(`#${page}-title`, data.title || page);
        if (!contentDiv) {
            console.warn(`Missing content container for section ${page}`);
            return;
        }

        if (window.PluginRegistry && multiPageConfig.plugins) {
            window.PluginRegistry.applyPlugins({
                id: page,
                plugins: multiPageConfig.plugins
            }, sectionRoot, listData, data);
        }

        drawList(listData, section, contentDiv, data);
        applyBackground(page);
    }

    function drawList(list, section, contentDiv, sectionData) {
        if (!contentDiv) return;
        contentDiv.innerHTML = '';

        if (!Array.isArray(list) || list.length === 0) {
            const placeholder = (metaConfig && metaConfig.emptyStates && metaConfig.emptyStates[section.id]) || 'No records available.';
            const p = document.createElement('p');
            p.className = 'text-homepage-1';
            p.textContent = placeholder;
            contentDiv.appendChild(p);
            return;
        }

        const type = section.itemType || section.id;
        const template = getSectionTemplate(section, type);

        // âœ… è°ƒè¯•ä¿¡æ¯
        console.log(`[drawList] section="${section.id}" type="${type}" template="${template}" list.length=${list.length}`);

        // âœ… ä¼˜å…ˆå°è¯•ä½¿ç”¨ TemplateRegistry ä¸­çš„æ¨¡æ¿ï¼ˆæ•´æ®µäº¤ç”±æ¨¡æ¿è‡ªè¡Œæ¸²æŸ“ï¼‰
        const customRenderer = window.TemplateRegistry?.get?.(template);
        if (typeof customRenderer === 'function') {
            console.log(`[TemplateRegistry][USE] Custom template found: "${template}"`);
            try {
                customRenderer(list, section, contentDiv);
                return; // âœ… è‡ªå®šä¹‰æ¨¡æ¿å·²å¤„ç†å®Œæ¯•
            } catch (err) {
                console.error(`[TemplateRegistry][ERROR] Failed to render "${template}":`, err);
            }
        }

        // âš™ï¸ å¦åˆ™å›žé€€åˆ°é»˜è®¤æ¸²æŸ“é€»è¾‘ï¼ˆå…¼å®¹æ—§æ¨¡æ¿ï¼‰
        list.forEach(entry => {
            const block = document.createElement('div');
            block.className = 'section-text-block';
            renderEntryByTemplate(block, entry, section, template, type);
            if (block.childElementCount > 0) {
                contentDiv.appendChild(block);
            }
        });

        if (type === 'blog' && templateSupportsArchive(template)) {
            appendBlogArchiveCallout(contentDiv, getSectionArchiveLabel(section, sectionData));
        }
    }


    function getSectionArchiveLabel(section, sectionData) {
        if (!sectionData) return '';
        if (typeof sectionData.archive_label === 'string') return sectionData.archive_label;
        if (sectionData.labels && typeof sectionData.labels.archive === 'string') return sectionData.labels.archive;
        if (sectionData.labels && typeof sectionData.labels.archive_label === 'string') return sectionData.labels.archive_label;
        return '';
    }

    function getSectionTemplate(section, type) {
        if (!section) return 'default';
        if (section.template) return section.template;
        const key = type || section.itemType || section.id;
        if (metaConfig && metaConfig.itemTypes && metaConfig.itemTypes[key] && metaConfig.itemTypes[key].template) {
            return metaConfig.itemTypes[key].template;
        }
        return 'default';
    }

    function templateSupportsArchive(template) {
        const name = (template || '').toLowerCase();
        return name === 'paper-card' || name === 'meta-card' || name === 'feature-card' || name === 'card';
    }

    function renderEntryByTemplate(block, entry, section, template, type) {
        appendSortMetadata(block, entry);

        // âœ… ä¼˜å…ˆæŸ¥æ‰¾ TemplateRegistry ä¸­æ˜¯å¦å®šä¹‰äº†å¯¹åº”æ¨¡æ¿
        const renderer = window.TemplateRegistry?.get?.(template);
        if (typeof renderer === 'function') {
            console.log(`[TemplateRegistry][GET] template: ${template}`, renderer);
            try {
                // è‡ªå®šä¹‰æ¨¡æ¿å¤§å¤šä»¥ (items, section, contentDiv) å½¢å¼å®šä¹‰
                // æˆ‘ä»¬å•ç‹¬åŒ…è£…å½“å‰ entry æˆæ•°ç»„ä¼ å…¥
                renderer([entry], section, block);
                return; // âœ… æˆåŠŸäº¤ç»™è‡ªå®šä¹‰æ¨¡æ¿æ¸²æŸ“
            } catch (err) {
                console.error(`[TemplateRegistry][ERROR] renderer("${template}") failed:`, err);
            }
        }

        // âš™ï¸ å¦åˆ™ä½¿ç”¨é»˜è®¤æ¸²æŸ“åˆ†æ”¯ï¼ˆä¿æŒæ—§é€»è¾‘ï¼‰
        switch ((template || '').toLowerCase()) {
            case 'paper-card':
            case 'meta-card':
            case 'feature-card':
            case 'card':
                renderMetaCard(block, entry, type);
                break;
            case 'timeline':
                renderTimelineEntry(block, entry);
                break;
            case 'list-inline':
                renderListInlineEntry(block, entry);
                break;
            default:
                renderGenericEntry(block, entry, type);
                break;
        }
    }

    function renderListInlineEntry(block, entry) {
        const primary = entry && (entry.content || entry.title || entry.description);
        const line = formatStrongLine(entry && entry.date, primary);
        appendParagraph(block, line || primary || '');
    }

    function renderTimelineEntry(block, entry) {
        appendParagraph(block, formatTitleLine(entry && entry.title, entry && entry.org, entry && entry.date));
        appendParagraph(block, entry && entry.description);
    }

    function renderGenericEntry(block, entry, type) {
        const secondary = entry && (entry.org || entry.conference || entry.subtitle || entry.role || entry.location || '');
        appendParagraph(block, formatTitleLine(entry && entry.title, secondary, entry && entry.date));
        if (entry && entry.authors) appendParagraph(block, entry.authors);
        appendParagraph(block, entry && (entry.description || entry.summary || entry.content));
        appendLinks(block, entry ? entry.links : []);
    }

    function appendParagraph(block, text) {
        if (!text) return;
        const p = document.createElement('p');
        p.className = 'text-homepage-1';
        if (text instanceof Node) {
            p.appendChild(text);
        } else {
            p.innerHTML = text;
        }
        block.appendChild(p);
    }

    function appendLinks(block, links) {
        if (!Array.isArray(links) || links.length === 0) return;
        const p = document.createElement('p');
        p.className = 'text-homepage-1';
        links.forEach(link => {
            if (!link || !link.url) return;
            const anchor = document.createElement('a');
            anchor.href = link.url;
            anchor.target = '_blank';
            anchor.rel = 'noopener noreferrer';
            const label = link.type || link.label || 'Link';
            decorateLinkAnchor(anchor, link, label);
            const text = link.type ? `[${link.type}]` : (link.label ? `[${link.label}]` : '[Link]');
            anchor.appendChild(document.createTextNode(text));
            anchor.style.marginRight = '8px';
            anchor.classList.add('meta-inline-link');
            p.appendChild(anchor);
        });
        block.appendChild(p);
    }

    const CARD_DEFAULTS = {
        mediaField: 'image',
        titleField: 'title',
        subtitleFields: [],
        badgeField: '',
        badgeFields: [],
        badgeSeparator: ' Â· ',
        metaFields: [],
        descriptionFields: ['description', 'content'],
        detailsField: '',
        tagsField: 'tags',
        placeholderLabel: 'Media Placeholder',
        actions: [],
        primaryLink: { type: 'auto' }
    };

    function toArray(value) {
        if (!value) return [];
        return Array.isArray(value) ? value : [value];
    }

    function getTemplateOptions(type) {
        const definition = (metaConfig && metaConfig.itemTypes && metaConfig.itemTypes[type]) || {};
        const opts = definition.templateOptions || {};
        return {
            mediaField: opts.mediaField !== undefined ? opts.mediaField : CARD_DEFAULTS.mediaField,
            titleField: opts.titleField !== undefined ? opts.titleField : CARD_DEFAULTS.titleField,
            subtitleFields: toArray(opts.subtitleFields !== undefined ? opts.subtitleFields : CARD_DEFAULTS.subtitleFields),
            badgeField: opts.badgeField !== undefined ? opts.badgeField : CARD_DEFAULTS.badgeField,
            badgeFields: toArray(opts.badgeFields !== undefined ? opts.badgeFields : CARD_DEFAULTS.badgeFields),
            badgeSeparator: opts.badgeSeparator !== undefined ? opts.badgeSeparator : CARD_DEFAULTS.badgeSeparator,
            metaFields: toArray(opts.metaFields !== undefined ? opts.metaFields : CARD_DEFAULTS.metaFields),
            descriptionFields: toArray(opts.descriptionFields !== undefined ? opts.descriptionFields : CARD_DEFAULTS.descriptionFields),
            detailsField: opts.detailsField !== undefined ? opts.detailsField : CARD_DEFAULTS.detailsField,
            tagsField: opts.tagsField !== undefined ? opts.tagsField : CARD_DEFAULTS.tagsField,
            placeholderLabel: opts.placeholderLabel !== undefined ? opts.placeholderLabel : CARD_DEFAULTS.placeholderLabel,
            actions: Array.isArray(opts.actions) ? opts.actions : CARD_DEFAULTS.actions,
            primaryLink: opts.primaryLink || CARD_DEFAULTS.primaryLink
        };
    }

    function readField(entry, path) {
        if (!entry || !path) return '';
        if (path === '@lang') return currentLang;
        if (typeof path !== 'string') return '';
        if (path.includes('.')) {
            return path.split('.').reduce((acc, key) => (acc && acc[key] !== undefined ? acc[key] : ''), entry) || '';
        }
        return entry[path] !== undefined ? entry[path] : '';
    }

    function readFirstField(entry, fields) {
        const list = toArray(fields);
        for (let i = 0; i < list.length; i++) {
            const value = readField(entry, list[i]);
            if (value) return value;
        }
        return '';
    }

    function getArrayField(entry, field) {
        if (!field) return [];
        const value = readField(entry, field);
        if (Array.isArray(value)) return value.filter(Boolean);
        if (typeof value === 'string' && value.trim()) return [value.trim()];
        return [];
    }

    function gatherMetaFields(entry, fields) {
        return toArray(fields).map(field => readField(entry, field)).filter(Boolean);
    }

    function gatherBadgeFields(entry, fields) {
        return toArray(fields).map(field => readField(entry, field)).filter(Boolean);
    }

    function buildTemplateUrl(template, entry) {
        if (!template) return '';
        return template.replace(/{{(.*?)}}/g, (_, token) => {
            const key = token.trim();
            if (key === '@lang') return currentLang;
            const value = readField(entry, key);
            return value || '';
        });
    }

    function resolvePrimaryLink(entry, type, options) {
        const cfg = options.primaryLink || CARD_DEFAULTS.primaryLink;
        if (!cfg || !cfg.type || cfg.type === 'auto') return resolveEntryUrl(entry);
        switch (cfg.type) {
            case 'field':
                return isValidUrl(readField(entry, cfg.field)) ? readField(entry, cfg.field) : '';
            case 'template':
                return buildTemplateUrl(cfg.template, entry);
            case 'blogSlug':
                return buildBlogUrl(entry);
            default:
                return resolveEntryUrl(entry);
        }
    }

    function renderMetaCard(block, entry, type) {
        if (!entry) return;
        const { data, options } = buildMetaCardData(entry, type);
        block.classList.add('meta-card', `meta-card--${type}`);

        const media = createMediaSlot(data.image, data.title, options.placeholderLabel);
        if (media) block.appendChild(media);

        const content = document.createElement('div');
        content.className = 'meta-card-content';

        const header = document.createElement('div');
        header.className = 'blog-card-header meta-card-header';

        const titleRow = document.createElement('div');
        titleRow.className = 'meta-card-title-row';
        const titleEl = createMetaCardTitle(data.title, data.url);
        titleRow.appendChild(titleEl);
        if (data.topRight) {
            const badge = document.createElement('span');
            badge.className = 'meta-card-top-right';
            badge.innerHTML = data.topRight;
            titleRow.appendChild(badge);
        }
        header.appendChild(titleRow);

        if (data.subtitle) {
            const subtitle = document.createElement('div');
            subtitle.className = 'meta-card-subtitle';
            subtitle.innerHTML = data.subtitle;
            header.appendChild(subtitle);
        }

        if (data.meta.length) {
            const meta = buildMetaLine(data.meta);
            if (meta) header.appendChild(meta);
        }

        content.appendChild(header);

        if (data.description) {
            const summary = document.createElement('p');
            summary.className = 'blog-summary meta-card-summary';
            summary.innerHTML = data.description;
            content.appendChild(summary);
        }

        if (data.details.length) {
            const list = document.createElement('ul');
            list.className = 'meta-card-list';
            data.details.forEach(item => {
                if (!item) return;
                const li = document.createElement('li');
                li.innerHTML = item;
                list.appendChild(li);
            });
            if (list.childElementCount) content.appendChild(list);
        }

        if (data.tags.length) {
            const tags = createTagList(data.tags);
            if (tags) {
                tags.classList.add('meta-card-tags');
                content.appendChild(tags);
            }
        }

        const actions = buildCardActions(entry, data, type, options);
        if (actions) content.appendChild(actions);

        block.appendChild(content);
    }

    function buildMetaCardData(entry, type) {
        const options = getTemplateOptions(type);
        const data = {
            title: readField(entry, options.titleField) || 'Untitled',
            subtitle: readFirstField(entry, options.subtitleFields),
            meta: gatherMetaFields(entry, options.metaFields),
            description: readFirstField(entry, options.descriptionFields),
            details: getArrayField(entry, options.detailsField),
            tags: getArrayField(entry, options.tagsField),
            url: resolvePrimaryLink(entry, type, options),
            image: readField(entry, options.mediaField),
            topRight: ''
        };

        const badgeValues = gatherBadgeFields(entry, options.badgeFields);
        if (badgeValues.length) {
            const separator = options.badgeSeparator || CARD_DEFAULTS.badgeSeparator;
            data.topRight = badgeValues.join(separator);
        } else if (options.badgeField) {
            data.topRight = readField(entry, options.badgeField);
        }

        return { data, options };
    }

    function createMetaCardTitle(title, url) {
        const isLink = isValidUrl(url);
        const element = document.createElement(isLink ? 'a' : 'span');
        element.className = 'blog-card-title meta-card-title';
        element.innerHTML = title || 'Untitled';
        if (isLink) {
            element.href = url;
            if (isExternalUrl(url)) {
                element.target = '_blank';
                element.rel = 'noopener noreferrer';
            }
        }
        return element;
    }

    function buildMetaLine(values) {
        const filtered = values.filter(Boolean);
        if (!filtered.length) return null;
        const meta = document.createElement('div');
        meta.className = 'blog-meta meta-card-meta';
        filtered.forEach(text => {
            const span = document.createElement('span');
            span.className = 'meta-card-meta-item';
            span.innerHTML = text;
            meta.appendChild(span);
        });
        return meta;
    }

    function buildCardActions(entry, data, type, options) {
        const extraLinks = buildExtraLinks(entry, data.url);
        const actionsConfig = Array.isArray(options.actions) ? options.actions : [];
        if (!extraLinks.length && !actionsConfig.length) return null;
        const container = document.createElement('div');
        container.className = 'blog-actions meta-card-actions';

        extraLinks.forEach(link => {
            link.classList.add('meta-card-extra-link');
            container.appendChild(link);
        });

        actionsConfig.forEach(action => {
            if (!action || !action.type) return;
            switch (action.type) {
                case 'readMore': {
                    const url = data.url || resolvePrimaryLink(entry, type, options);
                    if (!isValidUrl(url)) break;
                    const readMore = document.createElement('a');
                    readMore.className = 'blog-read-more meta-card-read-more';
                    readMore.href = url;
                    const label = resolveActionLabel(action.label) || entry && entry.read_more_label || getBlogReadMoreLabel();
                    readMore.innerHTML = `<span>${label}</span><i class="fas fa-arrow-right"></i>`;
                    container.appendChild(readMore);
                    break;
                }
                default:
                    break;
            }
        });

        return container.childElementCount ? container : null;
    }

    function resolveActionLabel(labelConfig) {
        if (!labelConfig) return '';
        if (typeof labelConfig === 'string') return labelConfig;
        if (typeof labelConfig === 'object') {
            return labelConfig[currentLang] || labelConfig.en || '';
        }
        return '';
    }

    function buildExtraLinks(entry, primaryUrl) {
        if (!entry || !Array.isArray(entry.links)) return [];
        const seen = new Set();
        const primary = typeof primaryUrl === 'string' ? primaryUrl.trim() : '';
        return entry.links.reduce((acc, link) => {
            if (!link || !link.url || !isValidUrl(link.url)) return acc;
            const url = link.url.trim();
            if (!url || seen.has(url)) return acc;
            seen.add(url);
            const anchor = document.createElement('a');
            anchor.className = 'blog-extra-link';
            anchor.href = url;
            const label = link.type || link.label || url;
            decorateLinkAnchor(anchor, link, label);
            anchor.appendChild(document.createTextNode(label));
            if (link.external === false) {
                anchor.target = '_self';
            } else if (isExternalUrl(url)) {
                anchor.target = '_blank';
                anchor.rel = 'noopener noreferrer';
            } else {
                anchor.target = '_self';
            }
            if (primary && url === primary) {
                anchor.classList.add('meta-card-extra-link--primary');
            }
            anchor.classList.add('meta-link');
            acc.push(anchor);
            return acc;
        }, []);
    }

    function resolveEntryUrl(entry) {
        if (!entry || typeof entry !== 'object') return '';
        const direct = typeof entry.url === 'string' ? entry.url.trim() : '';
        if (isValidUrl(direct)) return direct;
        if (Array.isArray(entry.links)) {
            const candidate = entry.links.find(link => link && typeof link.url === 'string' && isValidUrl(link.url));
            if (candidate) return candidate.url.trim();
        }
        return '';
    }

    function isValidUrl(url) {
        if (!url) return false;
        const trimmed = url.trim();
        if (!trimmed || trimmed === '#' || trimmed.toLowerCase().startsWith('javascript:')) return false;
        return true;
    }

    function isExternalUrl(url) {
        return /^https?:\/\//i.test(url);
    }

    function appendBlogArchiveCallout(container, label) {
        if (!container || container.querySelector('.blog-archive-callout')) return;
        const wrapper = document.createElement('div');
        wrapper.className = 'blog-archive-callout';
        const link = document.createElement('a');
        link.className = 'blog-archive-link blog-read-more';
        link.href = './blogs/index.html';
        const text = label || getBlogArchiveLabel();
        link.innerHTML = `<span>${text}</span><i class="fas fa-arrow-right"></i>`;
        wrapper.appendChild(link);
        container.appendChild(wrapper);
    }

    function getLinkIconPath(link) {
        if (!link || typeof link !== 'object') return '';

        // æ£€æŸ¥å½“å‰æ˜¯å¦æ˜¯æš—è‰²æ¨¡å¼
        const isDark = document.body.classList.contains('dark-mode') ||
            window.matchMedia('(prefers-color-scheme: dark)').matches;

        // ä¼˜å…ˆä½¿ç”¨ dark_icon
        if (isDark && typeof link.dark_icon === 'string' && link.dark_icon.trim()) {
            return link.dark_icon.trim();
        }

        // å¦åˆ™ä½¿ç”¨æ™®é€š icon
        const direct = typeof link.icon === 'string' ? link.icon.trim() : '';
        if (direct) return direct;

        // æœ€åŽå…œåº• iconUrl
        const fallback = typeof link.iconUrl === 'string' ? link.iconUrl.trim() : '';
        return fallback || '';
    }

    function decorateLinkAnchor(anchor, link, label) {
        if (!anchor) return;
        anchor.classList.add('meta-link');

        const applyIcon = () => {
            const iconPath = getLinkIconPath(link);
            console.log("iconPath=")
            console.log(iconPath)
            if (!iconPath) return;

            // åˆ é™¤æ—§å›¾æ ‡ï¼Œé¿å…é‡å¤
            const existing = anchor.querySelector('img.meta-link-icon');
            if (existing) existing.remove();

            const img = document.createElement('img');
            img.src = iconPath;
            img.alt = label ? `${label} icon` : 'Link icon';
            img.className = 'meta-link-icon';
            img.loading = 'lazy';
            anchor.insertBefore(img, anchor.firstChild);
        };

        applyIcon();

        // ðŸ”„ ç›‘å¬æš—è‰²æ¨¡å¼åˆ‡æ¢æ—¶è‡ªåŠ¨æ›´æ–°å›¾æ ‡
        const observer = new MutationObserver(() => applyIcon());
        observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
    }

    function buildBlogUrl(entry, lang = currentLang) {
        if (!entry) return '';
        if (entry.url && isValidUrl(entry.url)) return entry.url;
        const slug = entry.slug;
        if (!slug) {
            const firstLink = Array.isArray(entry.links) && entry.links.length ? entry.links[0].url : '';
            return isValidUrl(firstLink) ? firstLink : '';
        }
        const params = new URLSearchParams({
            slug: slug,
            lang: lang || currentLang
        });
        return `./blogs/post.html?${params.toString()}`;
    }

    function createTagList(tags) {
        if (!Array.isArray(tags) || tags.length === 0) return null;
        const wrapper = document.createElement('div');
        wrapper.className = 'blog-tags';
        tags.forEach(tag => {
            if (!tag) return;
            const span = document.createElement('span');
            span.className = 'blog-tag meta-card-tag';
            span.innerHTML = tag;
            wrapper.appendChild(span);
        });
        return wrapper;
    }

    function getBlogReadMoreLabel(lang = currentLang) {
        const labels = BLOG_LABELS.readMore || {};
        return labels[lang] || labels.en || 'Read more';
    }

    function getBlogArchiveLabel(lang = currentLang) {
        const labels = BLOG_LABELS.archive || {};
        return labels[lang] || labels.en || 'View all posts';
    }

    function createMediaSlot(src, title, placeholderLabel = 'Media Placeholder') {
        const wrapper = document.createElement('div');
        wrapper.className = 'meta-card-media';
        const hasImage = typeof src === 'string' && src.trim();
        if (hasImage) {
            const img = document.createElement('img');
            img.src = src;
            img.alt = title || 'Preview';
            img.loading = 'lazy';
            wrapper.appendChild(img);
        } else {
            wrapper.classList.add('meta-card-media--placeholder');
            const span = document.createElement('span');
            span.textContent = placeholderLabel || 'Media Placeholder';
            wrapper.appendChild(span);
        }
        return wrapper;
    }

    function appendSortMetadata(block, entry) {
        if (!entry || typeof entry !== 'object') return;
        if (entry.date) {
            block.dataset.sortDate = entry.date;
            const dateMarker = document.createElement('span');
            dateMarker.dataset.sortDate = entry.date;
            dateMarker.style.display = 'none';
            dateMarker.textContent = entry.date;
            block.appendChild(dateMarker);
        }
        if (entry.title) {
            block.dataset.sortTitle = entry.title;
            const titleMarker = document.createElement('span');
            titleMarker.dataset.sortTitle = entry.title;
            titleMarker.style.display = 'none';
            titleMarker.textContent = entry.title;
            block.appendChild(titleMarker);
        }
    }

    function formatTitleLine(title, secondary, prefix) {
        const parts = [];
        if (title) {
            parts.push(`<strong>${title}</strong>`);
        }
        if (secondary) {
            parts.push(secondary);
        }
        if (prefix) {
            parts.unshift(prefix);
        }
        return parts.join(' Â· ');
    }

    function formatStrongLine(primary, text) {
        if (!primary && !text) return '';
        if (!primary) return text || '';
        if (!text) return `<strong>${primary}</strong>`;
        return `<strong>${primary}</strong> ${text}`;
    }

    function stringifyEntry(entry) {
        try {
            return JSON.stringify(entry);
        } catch (err) {
            return '';
        }
    }

    function initializeLanguageDropdown() {
        const languageLink = document.querySelector('#navbar-language');
        const languageDropdown = document.querySelector('#language-dropdown');
        if (languageLink && languageDropdown) {
            // åˆå§‹ä¿æŒæ”¶èµ·
            languageDropdown.classList.remove('is-active');

            languageLink.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const willOpen = !languageDropdown.classList.contains('is-active');
                if (willOpen) {
                    languageDropdown.classList.remove('is-closing');
                    languageDropdown.classList.add('is-active');
                } else {
                    languageDropdown.classList.add('is-closing');
                    setTimeout(() => {
                        languageDropdown.classList.remove('is-active');
                        languageDropdown.classList.remove('is-closing');
                    }, 350);
                }
            });
            document.addEventListener('click', (e) => {
                if (!languageDropdown.contains(e.target) && languageDropdown.classList.contains('is-active')) {
                    languageDropdown.classList.add('is-closing');
                    setTimeout(() => {
                        languageDropdown.classList.remove('is-active');
                        languageDropdown.classList.remove('is-closing');
                    }, 350);
                }
            });
        }
    }

    function initializeLayoutMode() {
        const layoutModeToggle = document.getElementById('layout-mode-toggle');
        if (layoutModeToggle) {
            layoutModeToggle.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.setItem('layoutMode', 'single');
                window.location.href = 'index.html?scroll=top';
            });
        }
    }

    function initializeDarkMode() {
        const darkModeToggleMobile = document.getElementById('dark-mode-toggle-mobile');
        const body = document.body;
        const isDarkMode = localStorage.getItem('darkMode') === 'true';
        if (isDarkMode) {
            body.classList.add('dark-mode');
            if (darkModeToggleMobile) darkModeToggleMobile.innerHTML = '<i class="fas fa-sun"></i>';
        } else {
            if (darkModeToggleMobile) darkModeToggleMobile.innerHTML = '<i class="fas fa-moon"></i>';
        }
        function toggleDarkMode() {
            const isCurrentlyDark = body.classList.contains('dark-mode');
            if (isCurrentlyDark) {
                body.classList.remove('dark-mode');
                localStorage.setItem('darkMode', 'false');
                if (darkModeToggleMobile) darkModeToggleMobile.innerHTML = '<i class="fas fa-moon"></i>';
            } else {
                body.classList.add('dark-mode');
                localStorage.setItem('darkMode', 'true');
                if (darkModeToggleMobile) darkModeToggleMobile.innerHTML = '<i class="fas fa-sun"></i>';
            }
            applyBackground(getPageKey());
        }

        if (darkModeToggleMobile) {
            darkModeToggleMobile.addEventListener('click', (e) => {
                e.preventDefault();
                toggleDarkMode();
            });
        }
    }

    function initializeBackToTop() {
        const backToTopButton = document.getElementById('back-to-top');
        window.addEventListener('scroll', () => {
            if (window.pageYOffset > 300) backToTopButton.classList.add('show'); else backToTopButton.classList.remove('show');
        });
        backToTopButton.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }

    function initializeHamburgerAutoClose() {
        const burger = document.querySelector('.navbar-burger');
        const menu = document.querySelector('.navbar-menu');
        if (!burger || !menu) return;
        document.addEventListener('click', (e) => {
            if (!menu.contains(e.target) && menu.classList.contains('is-active')) {
                menu.classList.add('is-closing');
                setTimeout(() => {
                    menu.classList.remove('is-active');
                    menu.classList.remove('is-closing');
                    burger.classList.remove('is-active');
                }, 100);
            }
        });
    }

    function initializeNavbarResizeReset() {
        const navbarMenu = document.querySelector('.navbar-menu');
        const navbarBurger = document.querySelector('.navbar-burger');
        if (!navbarMenu || !navbarBurger) return;

        let wasDesktop = window.innerWidth >= 1024;

        function resetState() {
            navbarMenu.classList.remove('is-active', 'is-closing');
            navbarBurger.classList.remove('is-active');
        }

        if (wasDesktop) resetState();

        window.addEventListener('resize', () => {
            const isDesktop = window.innerWidth >= 1024;
            if (isDesktop && !wasDesktop) {
                resetState();
            }
            wasDesktop = isDesktop;
        });
    }
    function initializeHomeLink() {
        const home = document.getElementById('navbar-home');
        if (home) {
            home.addEventListener('click', (e) => {
                e.preventDefault();
                goTo('home');
            });
        }
    }

    window.addEventListener('popstate', () => renderPage().then(() => applyBackground(getPageKey())));

    document.addEventListener('DOMContentLoaded', () => {
        // å¤šé¡µå®¹å™¨
        renderPage().then(() => applyBackground(getPageKey()));
        initializeLanguageDropdown();
        initializeLayoutMode();
        initializeDarkMode();
        initializeBackToTop();
        initializeHomeLink();
        wireNavLinks();
        initializeHamburgerAutoClose();
        initializeNavbarResizeReset();
    });
</script>

</html>