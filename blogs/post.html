<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blog Post</title>
  <meta name="author" content="Phospheneser">
  <meta name="copyright" content="© 2024 Phospheneser. All rights reserved.">
  <link rel="stylesheet" href="../static/css/bulma.min.css">
  <link rel="stylesheet" href="../static/css/index.css">
  <style>
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, rgba(239, 246, 255, 0.9), rgba(241, 245, 249, 0.95));
      transition: background 0.3s ease;
    }

    body.dark-mode {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.98));
    }

    .post-topbar {
      position: sticky;
      top: 0;
      z-index: 30;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 16px 24px;
      backdrop-filter: blur(12px);
      background: rgba(255, 255, 255, 0.85);
      border-bottom: 1px solid rgba(148, 163, 184, 0.24);
    }

    body.dark-mode .post-topbar {
      background: rgba(15, 23, 42, 0.85);
      border-bottom-color: rgba(71, 85, 105, 0.55);
    }

    .post-topbar-left,
    .post-topbar-right {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .post-nav-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: #1f2d3d;
      text-decoration: none;
      font-size: 0.95rem;
      transition: color 0.2s ease;
    }

    .post-nav-link:hover {
      color: #3273dc;
    }

    body.dark-mode .post-nav-link {
      color: #e2e8f0;
    }

    body.dark-mode .post-nav-link:hover {
      color: #9db6ff;
    }

    .post-dark-toggle {
      border: none;
      background: rgba(50, 115, 220, 0.12);
      color: #1f2d3d;
      border-radius: 999px;
      width: 40px;
      height: 40px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .post-dark-toggle:hover {
      background: rgba(50, 115, 220, 0.2);
    }

    body.dark-mode .post-dark-toggle {
      background: rgba(148, 163, 184, 0.18);
      color: #f1f5f9;
    }

    body.dark-mode .post-dark-toggle:hover {
      background: rgba(148, 163, 184, 0.3);
    }

    .post-language-switcher {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .post-lang-button {
      border: 1px solid rgba(50, 115, 220, 0.3);
      background: rgba(255, 255, 255, 0.9);
      color: #275da8;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .post-lang-button.is-active {
      background: #3273dc;
      color: #fff;
      border-color: transparent;
      box-shadow: 0 10px 24px rgba(50, 115, 220, 0.32);
    }

    body.dark-mode .post-lang-button {
      background: rgba(15, 23, 42, 0.9);
      border-color: rgba(129, 140, 248, 0.4);
      color: #c7d2fe;
    }

    body.dark-mode .post-lang-button.is-active {
      background: #7c9bff;
      color: #0f172a;
      border-color: transparent;
    }

    .post-wrapper {
      max-width: 920px;
      margin: 48px auto 120px;
      padding: 0 24px 64px;
      background: rgba(255, 255, 255, 0.94);
      border-radius: 28px;
      box-shadow: 0 30px 80px rgba(15, 23, 42, 0.1);
      border: 1px solid rgba(148, 163, 184, 0.24);
      overflow: hidden;
    }

    body.dark-mode .post-wrapper {
      background: rgba(17, 24, 39, 0.92);
      border-color: rgba(129, 140, 248, 0.35);
      box-shadow: 0 36px 100px rgba(2, 6, 23, 0.6);
    }

    .post-hero {
      padding: 48px 48px 16px;
      text-align: center;
    }

    .post-hero h1 {
      font-size: 2.85rem;
      font-weight: 700;
      margin-bottom: 16px;
      color: #0f172a;
    }

    body.dark-mode .post-hero h1 {
      color: #f8fafc;
    }

    .post-excerpt {
      font-size: 1.1rem;
      line-height: 1.75;
      color: #4a5568;
      margin-bottom: 18px;
    }

    body.dark-mode .post-excerpt {
      color: #cbd5f5;
    }

    .post-meta {
      display: inline-flex;
      gap: 12px;
      flex-wrap: wrap;
      color: #64748b;
      font-size: 0.95rem;
      align-items: center;
    }

    body.dark-mode .post-meta {
      color: #cbd5f5;
    }

    .post-tags {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 18px;
    }

    .post-tag {
      background: rgba(50, 115, 220, 0.12);
      color: #285196;
      padding: 6px 14px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.85rem;
      letter-spacing: 0.02em;
    }

    body.dark-mode .post-tag {
      background: rgba(129, 140, 248, 0.2);
      color: #dde4ff;
    }

    .post-cover {
      margin: 0 0 24px;
      border-radius: 24px;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.12);
    }

    .post-cover-media {
      width: 100%;
      background: #f5f7fb;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      aspect-ratio: 16 / 9;
      min-height: 0;
    }

    .post-cover-media img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .post-cover-media--placeholder {
      background: repeating-linear-gradient(135deg, rgba(50, 115, 220, 0.08) 0, rgba(50, 115, 220, 0.08) 20px, rgba(50, 115, 220, 0.16) 20px, rgba(50, 115, 220, 0.16) 40px);
      color: #4f5b62;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 0.85rem;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .post-cover-media--placeholder span {
      opacity: 0.7;
    }

    .post-content {
      padding: 24px 48px 32px;
      color: #1f2937;
      font-size: 1.05rem;
      line-height: 1.85;
    }

    .post-content h2,
    .post-content h3,
    .post-content h4 {
      margin-top: 32px;
      margin-bottom: 16px;
      color: #0f172a;
      font-weight: 700;
    }

    .post-content p {
      margin-bottom: 18px;
    }

    .post-content blockquote {
      margin: 24px 0;
      padding: 20px;
      background: rgba(50, 115, 220, 0.12);
      border-left: 4px solid #3273dc;
      border-radius: 12px;
      font-style: italic;
      color: #1e2a38;
    }

    .post-content pre {
      background: #0f172a;
      color: #f8fafc;
      padding: 20px;
      border-radius: 16px;
      overflow-x: auto;
      font-size: 0.9rem;
    }

    body.dark-mode .post-cover-media {
      background: rgba(15, 23, 42, 0.68);
      box-shadow: 0 28px 60px rgba(2, 6, 23, 0.55);
    }

    body.dark-mode .post-cover-media--placeholder {
      background: repeating-linear-gradient(135deg, rgba(129, 140, 248, 0.14) 0, rgba(129, 140, 248, 0.14) 20px, rgba(129, 140, 248, 0.22) 20px, rgba(129, 140, 248, 0.22) 40px);
      color: #dbeafe;
    }

    @supports not (aspect-ratio: 16 / 9) {
      .post-cover-media {
        height: 0;
        padding-bottom: 56.25%;
        min-height: 0;
      }

      .post-cover-media img,
      .post-cover-media--placeholder {
        position: absolute;
        inset: 0;
      }
    }

    body.dark-mode .post-content {
      color: #e2e8f0;
    }

    body.dark-mode .post-content h2,
    body.dark-mode .post-content h3,
    body.dark-mode .post-content h4 {
      color: #f8fafc;
    }

    body.dark-mode .post-content blockquote {
      background: rgba(129, 140, 248, 0.14);
      border-left-color: rgba(129, 140, 248, 0.8);
      color: #e2e8f0;
    }

    .post-actions {
      padding: 0 48px 48px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 16px;
      align-items: center;
    }

    .post-extra-links {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .post-extra-links a {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.16);
      color: #274160;
      font-weight: 600;
      text-decoration: none;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .post-extra-links a:hover {
      background: rgba(148, 163, 184, 0.28);
      color: #0f172a;
    }

    body.dark-mode .post-extra-links a {
      background: rgba(71, 85, 105, 0.36);
      color: #dbeafe;
    }

    body.dark-mode .post-extra-links a:hover {
      background: rgba(71, 85, 105, 0.48);
      color: #f8fafc;
    }

    .post-back-deck {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .post-back-deck a {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #3273dc;
      font-weight: 600;
      text-decoration: none;
    }

    .post-back-deck a:hover {
      color: #275da8;
    }

    body.dark-mode .post-back-deck a {
      color: #9db6ff;
    }

    body.dark-mode .post-back-deck a:hover {
      color: #c3d8ff;
    }

    .post-status-message {
      max-width: 680px;
      margin: 80px auto;
      text-align: center;
      color: #4a5568;
      font-size: 1.05rem;
    }

    body.dark-mode .post-status-message {
      color: #cbd5f5;
    }

    .post-footer {
      padding: 24px;
      text-align: center;
      color: #64748b;
    }

    body.dark-mode .post-footer {
      color: #cbd5f5;
    }

    @media screen and (max-width: 768px) {
      .post-wrapper {
        margin: 32px 16px 80px;
        padding: 0 0 48px;
      }

      .post-hero,
      .post-content,
      .post-actions {
        padding-left: 24px;
        padding-right: 24px;
      }

      .post-hero h1 {
        font-size: 2.2rem;
      }
    }
  </style>
</head>

<body>
  <header class="post-topbar">
    <div class="post-topbar-left">
      <a class="post-nav-link" id="post-back-to-blog" href="./index.html">
        <i class="fas fa-arrow-left"></i>
        <span id="post-back-blog-text">Back to blog</span>
      </a>
      <a class="post-nav-link" id="post-back-to-home" href="../index.html#blogs">
        <i class="fas fa-home"></i>
        <span id="post-back-home-text">Home</span>
      </a>
    </div>
    <div class="post-topbar-right">
      <button class="post-dark-toggle" id="post-dark-toggle" aria-label="Toggle dark mode">
        <i class="fas fa-moon"></i>
      </button>
      <div class="post-language-switcher" id="post-language-switcher"></div>
    </div>
  </header>

  <main id="post-main">
    <article class="post-wrapper" id="post-wrapper" hidden>
      <section class="post-hero">
        <div class="post-cover" id="post-cover"></div>
        <p class="post-excerpt" id="post-excerpt"></p>
        <h1 id="post-title">Blog Post</h1>
        <div class="post-meta" id="post-meta"></div>
        <div class="post-tags" id="post-tags"></div>
      </section>
      <section class="post-content" id="post-content"></section>
      <section class="post-actions">
        <div class="post-extra-links" id="post-extra-links"></div>
        <div class="post-back-deck">
          <a href="./index.html" id="post-bottom-back-blog">
            <i class="fas fa-long-arrow-alt-left"></i>
            <span id="post-bottom-back-blog-text">Back to blog index</span>
          </a>
          <a href="../index.html#blogs" id="post-bottom-back-home">
            <i class="fas fa-arrow-up"></i>
            <span id="post-bottom-back-home-text">Back to homepage</span>
          </a>
        </div>
      </section>
    </article>
    <div class="post-status-message" id="post-status"></div>
  </main>

  <footer class="post-footer">
    <p id="post-footer-text">© 2024 Phospheneser. All rights reserved.</p>
  </footer>

  <script defer src="../static/js/fontawesome.all.min.js"></script>
  <script>
    const BLOG_LABELS = {
      readMore: {
        en: 'Read more',
        zh: '阅读全文',
        jp: '続きを読む'
      }
    };

    const FOOTER_FALLBACK = '© 2024 Phospheneser. All rights reserved.';

    const BLOG_POST_LABELS = {
      en: {
        backBlog: 'Back to blog',
        backHome: 'Home',
        bottomBackBlog: 'Back to blog index',
        bottomBackHome: 'Return to homepage',
        darkToLight: 'Switch to light mode',
        lightToDark: 'Switch to dark mode',
        updated: 'Updated',
        reading: 'read',
        missing: 'We could not find this article. Please check the URL or return to the blog index.'
      },
      zh: {
        backBlog: '返回博客',
        backHome: '主页',
        bottomBackBlog: '返回博客列表',
        bottomBackHome: '回到主页',
        darkToLight: '切换为浅色模式',
        lightToDark: '切换为深色模式',
        updated: '更新于',
        reading: '阅读',
        missing: '未找到对应文章，请检查链接或返回博客列表。'
      },
      jp: {
        backBlog: 'ブログに戻る',
        backHome: 'ホーム',
        bottomBackBlog: 'ブログ一覧へ戻る',
        bottomBackHome: 'ホームページへ戻る',
        darkToLight: 'ライトモードへ切り替える',
        lightToDark: 'ダークモードへ切り替える',
        updated: '更新日',
        reading: '読む',
        missing: '該当の記事が見つかりませんでした。リンクをご確認いただくか、ブログ一覧に戻ってください。'
      }
    };

    function isValidUrl(url) {
      if (!url) return false;
      const trimmed = url.trim();
      if (!trimmed || trimmed === '#' || trimmed.toLowerCase().startsWith('javascript:')) return false;
      return true;
    }

    let currentLang = (new URLSearchParams(window.location.search).get('lang')) || localStorage.getItem('lang') || 'en';
    let availableLanguages = ['en', 'zh', 'jp'];
    let metaConfig = null;
    let postLabels = BLOG_POST_LABELS.en;

    function getLinkIconPath(link) {
      if (!link || typeof link !== 'object') return '';
      const direct = typeof link.icon === 'string' ? link.icon.trim() : '';
      if (direct) return direct;
      const fallback = typeof link.iconUrl === 'string' ? link.iconUrl.trim() : '';
      return fallback || '';
    }

    function decorateLinkAnchor(anchor, link, label) {
      if (!anchor) return;
      anchor.classList.add('meta-link');
      const iconPath = getLinkIconPath(link);
      if (!iconPath) return;
      const img = document.createElement('img');
      img.src = iconPath;
      img.alt = label ? `${label} icon` : 'Link icon';
      img.className = 'meta-link-icon';
      img.loading = 'lazy';
      anchor.appendChild(img);
    }

    document.addEventListener('DOMContentLoaded', () => {
      initializeDarkMode();
      initializePostPage();
    });

    async function initializePostPage() {
      const slug = new URLSearchParams(window.location.search).get('slug');
      await updateFooter(currentLang);
      if (!slug) {
        renderStatus('missing');
        return;
      }

      await loadMeta();
      await loadPost(slug, currentLang);
    }

    async function loadMeta() {
      try {
        const res = await fetch('../data/meta.json');
        metaConfig = await res.json();
        if (metaConfig && Array.isArray(metaConfig.availableLanguages)) {
          availableLanguages = metaConfig.availableLanguages;
        }
      } catch (err) {
        console.error('Failed to load meta config:', err);
      }
    }

    async function loadPost(slug, lang) {
      let activeLang = lang;
      let entry = null;
      let blogsData = null;

      try {
        blogsData = await fetchBlogsForLanguage(activeLang);
        entry = findEntry(blogsData, slug);
        if (!entry && activeLang !== 'en') {
          const fallback = await fetchBlogsForLanguage('en');
          entry = findEntry(fallback, slug);
          activeLang = entry ? 'en' : lang;
          blogsData = entry ? fallback : blogsData;
        }
      } catch (err) {
        console.error(`Failed loading blog metadata for ${lang}`, err);
      }

      if (!entry) {
        renderStatus('missing');
        return;
      }

      const fallbackLabels = BLOG_POST_LABELS[activeLang] || BLOG_POST_LABELS.en;
      postLabels = Object.assign({}, fallbackLabels, blogsData.post_labels || {});
      currentLang = activeLang;
      localStorage.setItem('lang', activeLang);
      await updateFooter(activeLang);
      renderLanguageSwitcher(slug);
      renderNavigationLabels();
      if (typeof window.__updatePostDarkLabel === 'function') {
        window.__updatePostDarkLabel();
      }

      document.title = `${entry.title} | ${blogsData && blogsData.title ? blogsData.title : 'Blog'}`;

      const excerpt = document.getElementById('post-excerpt');
      const title = document.getElementById('post-title');
      const meta = document.getElementById('post-meta');
      const tags = document.getElementById('post-tags');
      const cover = document.getElementById('post-cover');
      const extraLinks = document.getElementById('post-extra-links');
      const wrapper = document.getElementById('post-wrapper');
      const status = document.getElementById('post-status');

      if (status) status.textContent = '';
      if (wrapper) wrapper.hidden = false;

      title.textContent = entry.title || 'Blog Post';
      excerpt.textContent = entry.summary || entry.description || '';
      renderMeta(meta, entry);
      renderTags(tags, entry);
      renderCover(cover, entry);
      renderExtraLinks(extraLinks, entry);

      await renderContent(slug, activeLang, entry);
    }

    function renderMeta(container, entry) {
      if (!container) return;
      container.innerHTML = '';
      const labels = postLabels;
      const parts = [];
      if (entry.post_time) parts.push(entry.post_time);
      if (entry.updated_at) parts.push(`${labels.updated} ${entry.updated_at}`);
      if (entry.author && typeof entry.author === 'string') parts.push(entry.author);

      if (!parts.length) return;
      parts.forEach((text, index) => {
        if (index > 0) {
          const bullet = document.createElement('span');
          bullet.textContent = '·';
          container.appendChild(bullet);
        }
        const span = document.createElement('span');
        span.textContent = text;
        container.appendChild(span);
      });
    }

    function renderTags(container, entry) {
      if (!container) return;
      container.innerHTML = '';
      if (!entry || !Array.isArray(entry.tags) || entry.tags.length === 0) return;
      entry.tags.forEach(tag => {
        const span = document.createElement('span');
        span.className = 'post-tag';
        span.textContent = tag;
        container.appendChild(span);
      });
    }

    function renderCover(container, entry) {
      if (!container) return;
      container.innerHTML = '';
      const slot = createCoverSlot(entry && entry.hero_image, entry && entry.title);
      container.appendChild(slot);
      container.hidden = false;
    }

    function createCoverSlot(src, title) {
      const wrapper = document.createElement('div');
      wrapper.className = 'post-cover-media';
      const hasImage = typeof src === 'string' && src.trim();
      if (hasImage) {
        const img = document.createElement('img');
        img.src = src;
        img.alt = title || 'Blog cover';
        img.loading = 'lazy';
        wrapper.appendChild(img);
      } else {
        wrapper.classList.add('post-cover-media--placeholder');
        const span = document.createElement('span');
        span.textContent = 'Cover Placeholder';
        wrapper.appendChild(span);
      }
      return wrapper;
    }

    function renderExtraLinks(container, entry) {
      if (!container) return;
      container.innerHTML = '';
      const links = buildBlogExtraLinks(entry, '');
      links.forEach(link => container.appendChild(link));
    }

    async function renderContent(slug, lang, entry) {
      const container = document.getElementById('post-content');
      const status = document.getElementById('post-status');
      if (!container) return;
      container.innerHTML = '';

      const primaryPath = `./posts/${slug}/${lang}.html`;
      const fallbackPath = lang === 'en' ? null : `./posts/${slug}/en.html`;

      let html = await fetchContent(primaryPath);
      if (!html && fallbackPath) {
        html = await fetchContent(fallbackPath);
      }

      if (html) {
        container.innerHTML = html;
        if (status) status.textContent = '';
      } else {
        container.innerHTML = '';
        if (status) {
          status.textContent = postLabels.missing || 'We could not find this article. Please check the URL or return to the blog index.';
        }
      }
    }

    async function fetchContent(path) {
      try {
        const res = await fetch(path);
        if (!res.ok) return null;
        return await res.text();
      } catch (err) {
        console.error('Failed to load content:', path, err);
        return null;
      }
    }

    async function updateFooter(lang) {
      const footer = document.getElementById('post-footer-text');
      if (!footer) return;
      let footerText = FOOTER_FALLBACK;
      try {
        const content = await fetchWebContent(lang);
        if (content && typeof content.footer === 'string' && content.footer.trim()) {
          footerText = content.footer;
        } else if (lang !== 'en') {
          const fallbackContent = await fetchWebContent('en');
          if (fallbackContent && typeof fallbackContent.footer === 'string' && fallbackContent.footer.trim()) {
            footerText = fallbackContent.footer;
          }
        }
      } catch (err) {
        console.error(`Failed to update footer for ${lang}:`, err);
      }
      footer.textContent = footerText;
    }

    async function fetchWebContent(lang) {
      try {
        const res = await fetch(`../data/${lang}/web_content.json`);
        if (!res.ok) return null;
        return await res.json();
      } catch (err) {
        console.error(`Failed to fetch web_content for ${lang}:`, err);
        return null;
      }
    }

    async function fetchBlogsForLanguage(lang) {
      const res = await fetch(`../data/${lang}/blogs.json`);
      if (!res.ok) throw new Error(`Failed to fetch blogs for ${lang}`);
      return await res.json();
    }

    function findEntry(blogsData, slug) {
      if (!blogsData) return null;
      const list = Array.isArray(blogsData.blogs) ? blogsData.blogs : [];
      return list.find(item => item && item.slug === slug) || null;
    }

    function renderStatus(type) {
      const wrapper = document.getElementById('post-wrapper');
      const status = document.getElementById('post-status');
      if (wrapper) wrapper.hidden = true;
      if (!status) return;
      if (type === 'missing') {
        status.textContent = postLabels.missing || 'We could not find this article. Please check the URL or return to the blog index.';
      }
    }

    function renderLanguageSwitcher(slug) {
      const container = document.getElementById('post-language-switcher');
      if (!container) return;
      container.innerHTML = '';
      availableLanguages.forEach(lang => {
        const label = (metaConfig && metaConfig.languageLabels && metaConfig.languageLabels[lang]) || lang;
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'post-lang-button' + (lang === currentLang ? ' is-active' : '');
        button.textContent = label;
        button.addEventListener('click', () => {
          if (lang === currentLang) return;
          const params = new URLSearchParams(window.location.search);
          params.set('lang', lang);
          params.set('slug', slug);
          window.location.search = params.toString();
        });
        container.appendChild(button);
      });
    }

    function renderNavigationLabels() {
      const labels = postLabels;
      const mapping = [
        ['post-back-blog-text', labels.backBlog],
        ['post-back-home-text', labels.backHome],
        ['post-bottom-back-blog-text', labels.bottomBackBlog],
        ['post-bottom-back-home-text', labels.bottomBackHome]
      ];
      mapping.forEach(([id, text]) => {
        const el = document.getElementById(id);
        if (el) el.textContent = text;
      });
    }

    function buildBlogExtraLinks(entry, blogUrl) {
      if (!entry || !Array.isArray(entry.links)) return [];
      return entry.links
        .filter(link => link && link.url && link.url !== blogUrl && isValidUrl(link.url))
        .map(link => {
          const anchor = document.createElement('a');
          anchor.href = link.url;
          const label = link.type || link.label || link.url;
          decorateLinkAnchor(anchor, link, label);
          anchor.appendChild(document.createTextNode(label));
          if (link.external === false) {
            anchor.target = '_self';
          } else {
            anchor.target = '_blank';
            anchor.rel = 'noopener noreferrer';
          }
          anchor.classList.add('meta-link');
          return anchor;
        });
    }

    function initializeDarkMode() {
      const toggle = document.getElementById('post-dark-toggle');
      const body = document.body;
      const isDarkMode = localStorage.getItem('darkMode') === 'true';
      if (isDarkMode) {
        body.classList.add('dark-mode');
        if (toggle) toggle.innerHTML = '<i class="fas fa-sun"></i>';
      }

      if (!toggle) return;
      const updateTitle = () => {
        const darkLabel = postLabels.darkToLight || 'Switch to light mode';
        const lightLabel = postLabels.lightToDark || 'Switch to dark mode';
        toggle.title = body.classList.contains('dark-mode') ? darkLabel : lightLabel;
      };
      updateTitle();
      window.__updatePostDarkLabel = updateTitle;

      toggle.addEventListener('click', () => {
        const currentlyDark = body.classList.contains('dark-mode');
        if (currentlyDark) {
          body.classList.remove('dark-mode');
          localStorage.setItem('darkMode', 'false');
          toggle.innerHTML = '<i class="fas fa-moon"></i>';
        } else {
          body.classList.add('dark-mode');
          localStorage.setItem('darkMode', 'true');
          toggle.innerHTML = '<i class="fas fa-sun"></i>';
        }
        updateTitle();
      });
    }
  </script>
</body>

</html>
