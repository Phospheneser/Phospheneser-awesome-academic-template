<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Academic Template</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-R2ZLMKHR2E"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-R2ZLMKHR2E');
  </script>

  <script>
    let metaConfig = null;
    function loadWordCloud() {
      const traits = [
        ["Leader", 30],
        ["Instructor", 15],
        ["Connector", 25],
        ["Smart", 15],
        ["Mature", 20],
        ["Impact-Driven", 40],
        ["Resilience", 30],
        ["Passionate", 20],
        ["Faithful", 30],
        ["Confident", 20]
        ["Innovative", 15],
        ["Questioner", 30],
        ["Insightful", 40],
        ["Visionary", 20],
        ["Emotionally Stable", 25],
      ];

      const canvas = document.getElementById("word-cloud");

      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      WordCloud(canvas, {
        list: traits, // 使用特性词语列表
        gridSize: Math.round(16 * window.innerWidth / 1024), // 网格大小，随屏幕变化调整
        weightFactor: window.innerWidth / 400, // 字体大小比例
        fontFamily: "Times, serif", // 字体
        color: function () {
          const colors = ["#1E88E5", "#F4511E", "#43A047", "#FB8C00", "#5E35B1"];
          return colors[Math.floor(Math.random() * colors.length)];
        },
        // backgroundColor: "#F0F4F8", // 柔和背景色
        rotateRatio: 0., // 减少文字旋转
        shuffle: true, // 随机排列单词
        shape: "circle", // 圆形布局
        drawOutOfBound: false,
      });
    }
  </script>

  <!-- 3D word cloud will be initialized dynamically -->

  <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Playfair+Display&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./static/css/bulma.min.css">
  <link rel="stylesheet" href="./static/css/bulma-carousel.min.css">
  <link rel="stylesheet" href="./static/css/bulma-slider.min.css">
  <link rel="stylesheet" href="./static/css/fontawesome.all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
  <link rel="stylesheet" href="./static/css/index.css">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script defer src="./static/js/fontawesome.all.min.js"></script>
  <script src="./static/js/bulma-carousel.min.js"></script>
  <script src="./static/js/bulma-slider.min.js"></script>
  <script src="./static/js/index.js"></script>
  <script src="./static/js/templates.js"></script>
  <script src="./static/js/plugins.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.0.6/wordcloud2.min.js"></script>
  <script src="https://www.goat1000.com/tagcanvas.min.js"></script>
  <style>
    /* 干掉 Bulma 默认箭头 */
    .navbar.is-primary .navbar-end .navbar-link::after,
    .navbar.is-primary .navbar-start .navbar-link::after {
      content: none !important;
      border: none !important;
    }
  </style>
</head>

<body>

  <div id="background-container"
    style="background-image:linear-gradient(rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.5)),url('./media/occupacy.jpg');background-size: cover; background-position: center;padding-top: 52px; padding-bottom: 20px; margin-top: -52px; width: 100vw; position: relative;">
    <nav class="navbar is-primary">
      <div class="navbar-brand">
        <a class="navbar-item" href="#" id="navbar-home" onclick="goHome()">
          <strong id="navbar-title">Home</strong>
        </a>

        <!-- 亮暗模式切换按钮（与 main.html 保持一致） -->
        <a class="navbar-item dark-mode-toggle-mobile" href="#" id="dark-mode-toggle-mobile" title="Toggle Dark Mode">
          <i class="fas fa-moon"></i>
        </a>
        <a class="navbar-item layout-mode-toggle" href="#" id="layout-mode-toggle" title="Switch to Single-page Mode">
          <i class="fas fa-layer-group"></i>
        </a>

        <!-- 汉堡菜单按钮 -->
        <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="top-navbar">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>

      <div id="top-navbar" class="navbar-menu">
        <div class="navbar-end">
          <div class="navbar-item has-dropdown" id="language-dropdown">
            <a class="navbar-link" id="navbar-language"><span id="lang-label">
                Language </span><i class="fas fa-chevron-left lang-arrow"></i>
            </a>
            <div class="navbar-dropdown" id="language-dropdown-menu">
              <!-- 语言按钮将动态生成 -->
            </div>
          </div>
        </div>
      </div>
    </nav>
    <div class="container has-text-centered">
      <div style="display: flex; justify-content: space-between; align-items: center; height: 300px;">
        <div style="flex: 1;display: flex; justify-content: center; align-items: center;">
          <div class="card-container">
            <!-- 卡片内容将动态生成 -->

            <!-- Arrow Buttons -->
            <button class="arrow-btn arrow-left" id="prev-btn">
              <i class="fas fa-arrow-left"></i>
            </button>
            <button class="arrow-btn arrow-right" id="next-btn">
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>

        <div style="flex: 1; display: flex; justify-content: center; align-items: center;">
          <figure class="image is-128x128 is-inline-block" style="width: 200px; height: 200px; margin: 0;">
            <img class="is-rounded" src="./media/personal.jpg" alt="Avatar" style="width: 100%; height: 100%;">
          </figure>
        </div>

        <div style="flex: 1; display: flex; justify-content: center; align-items: center;">
          <div id="canvas-container">
            <canvas id="word-cloud" width="400" height="300"></canvas>
            <ul id="tags">
              <!-- 词云标签将动态生成 -->
            </ul>
          </div>
        </div>
      </div>
      <h1 class="title is-size-3-tablet is-size-4-mobile" style="font-family: Futura;" id="main-title">
        Dream Big, Work Hard, Stay Humble.
      </h1>
      <p class="subtitle is-size-4-tablet is-size-5-mobile" style="font-family: Brush Script MT;" id="main-subtitle">
        ——Be Versatile, Be Great.
      </p>
      <div class="icon-box">
        <a href="https://github.com/Phospheneser" target="_blank">
          <i class="fab fa-github"></i>
        </a>
        <a href="https://scholar.google.com/citations?user=TSUlagkAAAAJ&hl=zh-CN" target="_blank">
          <i class="fas fa-graduation-cap"></i>
        </a>
        <a href="https://x.com/PhospheneserXu" target="_blank">
          <i class="fab fa-twitter"></i>
        </a>
        <a href="mailto:zxu24@m.fudan.edu.cn">
          <i class="fas fa-envelope"></i>
        </a>
      </div>
    </div>
  </div>


  <div id="meta-sections-root"></div>


  <footer class="footer">
    <div class="container">
      <div class="columns is-centered">
        <div class="column">
          <div class="content has-text-centered">
            <p id="footer-text">
              Edit by Joshua@2025.9.27
            </p>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <!-- 返回顶部按钮 -->
  <button id="back-to-top" class="back-to-top" title="返回顶部">
    <i class="fas fa-chevron-up"></i>
  </button>
  </div> <!-- 结束背景容器 -->

</body>

<script>
  let currentLang = localStorage.getItem('lang') || 'en';
  let availableLanguages = ['en', 'zh', 'jp']; // 将在元配置加载后被覆盖
  // 根据当前页面和localStorage确定布局模式
  function getInitialLayoutMode() {
    const stored = localStorage.getItem('layoutMode');
    if (stored) return stored;

    // 如果没有存储的模式，检查当前页面
    if (window.location.pathname.includes('main.html')) {
      return 'single'; // main.html默认单页模式
    } else {
      return 'multi'; // 其他页面默认多页模式
    }
  }

  let layoutMode = getInitialLayoutMode();

  function goHome() {
    window.scrollTo({
      top: 0,
      behavior: 'smooth'
    })
  }

  async function loadMeta() {
    try {
      const res = await fetch(`data/meta.json`);
      metaConfig = await res.json();
      if (Array.isArray(metaConfig.availableLanguages)) {
        availableLanguages = metaConfig.availableLanguages;
      }
    } catch (e) { console.error('Failed to load meta.json', e); }
  }

  function applyMetaVisibility() {
    if (!metaConfig || !Array.isArray(metaConfig.sections)) return;
    metaConfig.sections.forEach(sec => {
      const navEl = document.querySelector(`#navbar-${sec.id}`);
      if (navEl) navEl.style.display = sec.enabled ? '' : 'none';
      const sectionEl = document.querySelector(`#${sec.id}`);
      if (sectionEl && sectionEl.parentElement && sectionEl.parentElement.closest('section')) {
        sectionEl.parentElement.closest('section').style.display = sec.enabled ? '' : 'none';
      }
    });
  }

  function generateSocials(socials) {
    const box = document.querySelector('.icon-box');
    if (!box) return;
    box.innerHTML = '';
    (socials || []).forEach(s => {
      const a = document.createElement('a');
      a.href = s.url || '#';
      a.target = '_blank';
      const i = document.createElement('i');
      i.className = s.icon || 'fas fa-link';
      a.appendChild(i);
      box.appendChild(a);
    });
  }

  async function loadSectionDataMap(lang) {
    const map = {};
    if (!metaConfig || !Array.isArray(metaConfig.sections)) return map;
    const fetchTasks = metaConfig.sections.map(async (section) => {
      if (!section.enabled) return;
      const source = section.dataSource || section.id;
      try {
        const res = await fetch(`data/${lang}/${source}.json`);
        if (!res.ok) return;
        const data = await res.json();
        map[section.id] = data;
      } catch (err) {
        console.error(`Failed to load section data for ${section.id}`, err);
      }
    });
    await Promise.all(fetchTasks);
    return map;
  }

  async function loadContent(lang = currentLang) {
    const [webContentRes, cardsRes, wordcloudRes, sectionDataMap] = await Promise.all([
      fetch(`data/${lang}/web_content.json`),
      fetch(`data/${lang}/cards.json`),
      fetch(`data/${lang}/wordcloud.json`),
      loadSectionDataMap(lang)
    ]);

    const webContent = await webContentRes.json();
    const cards = await cardsRes.json();
    const wordcloud = await wordcloudRes.json();

    const cardsList = cards.cards || [];
    const wordcloudList = wordcloud.wordcloud || [];

    // 更新导航栏
    generateNavFromMeta(sectionDataMap);
    updateElement('#navbar-title', webContent.navbar_title);
    updateElement('#navbar-home', webContent.navbar_home);
    document.getElementById('lang-label').textContent = webContent.language;

    // 动态生成语言切换按钮
    generateLanguageButtons(webContent);

    // 元配置：头像与社交
    if (metaConfig && metaConfig.home && metaConfig.home.avatar) {
      const avatar = document.querySelector('#background-container img.is-rounded');
      if (avatar) avatar.src = metaConfig.home.avatar;
    }
    if (metaConfig && Array.isArray(metaConfig.socials)) {
      generateSocials(metaConfig.socials);
    }

    // 更新主页标题
    updateElement('#main-title', webContent.title);
    updateElement('#main-subtitle', webContent.subtitle);

    // 渲染 section
    renderSections(sectionDataMap);

    // 更新页脚
    updateElement('#footer-text', webContent.footer);

    // 按元配置控制导航与区块显示
    applyMetaVisibility();

    // 动态生成卡片与词云
    generateCards(cardsList);
    initializeCardSlider();
    generateWordCloud(wordcloudList);
    setTimeout(() => {
      generateWordCloud(wordcloudList);
    }, 100);

    applyBackground(getCurrentSectionId());
  }
  function ensureSearchBar(sectionRoot) {
    if (!sectionRoot) return;
    if (sectionRoot.querySelector('.meta-search')) return;
    const bar = document.createElement('input');
    bar.className = 'input meta-search';
    bar.placeholder = 'Search...';
    bar.style.margin = '10px 0 20px 0';
    sectionRoot.insertBefore(bar, sectionRoot.children[1] || null);
    return bar;
  }

  function getCurrentSectionId() {
    const hash = window.location.hash ? window.location.hash.replace('#', '') : '';
    return hash || 'home';
  }

  function applyBackground(sectionId) {
    const container = document.getElementById('background-container');
    if (!container || !metaConfig) return;

    const darkMode = document.body.classList.contains('dark-mode');
    const backgrounds = metaConfig.backgrounds || {};
    const section = metaConfig.sections ? metaConfig.sections.find(s => s.id === sectionId) : null;
    let key = (section && section.background) || (sectionId === 'home' ? (backgrounds.home ? 'home' : 'default') : null);
    if (!key || !backgrounds[key]) key = 'default';
    const defaultBg = backgrounds.default || {};
    const bgConfig = backgrounds[key] || {};
    const lightImage = bgConfig.light || defaultBg.light || './media/occupacy.jpg';
    const darkImage = bgConfig.dark || defaultBg.dark || '';

    let background;
    if (darkMode) {
      if (darkImage) {
        background = `linear-gradient(rgba(0, 0, 0, 0.35), rgba(0, 0, 0, 0.35)),url('${darkImage}')`;
      } else {
        background = `linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)),url('${lightImage}')`;
      }
    } else {
      background = `linear-gradient(rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.5)),url('${lightImage}')`;
    }

    container.style.backgroundImage = background;
  }

  function renderSections(sectionDataMap) {
    if (!metaConfig || !Array.isArray(metaConfig.sections)) return;
    ensureSectionSkeleton(metaConfig.sections, sectionDataMap);
    metaConfig.sections.forEach(section => {
      if (!section.enabled) return;

      const singlePageConfig = section.singlePage;
      if (!singlePageConfig || !singlePageConfig.enabled) return;

      const data = sectionDataMap[section.id];
      if (!data) return;

      if (section.id === 'about') {
        updateElement('#about-title', data.title || 'About');
        renderTextList('#about-texts', data.texts || data.paragraphs || []);
        return;
      }

      const container = document.querySelector(`#${section.id}`);
      if (!container) return;
      const contentDiv = container.children[1];
      if (!contentDiv) return;

      updateElement(`#${section.id}-title`, data.title || section.id);

      if (!section.itemType) return;
      const key = section.dataSource;
      const listData = (key && Array.isArray(data[key])) ? data[key] : (Array.isArray(data.items) ? data.items : []);
      if (!Array.isArray(listData)) return;
      drawList(listData, section, contentDiv);
    });
  }

  function drawList(list, section, contentDiv) {
    contentDiv.innerHTML = '';
    const type = section.itemType;
    const templateName = (metaConfig && metaConfig.itemTypes && metaConfig.itemTypes[type] && metaConfig.itemTypes[type].template) || (type === 'news' ? 'list-inline' : 'paper-card');
    const renderer = (window.TemplateRegistry && window.TemplateRegistry.get(templateName));
    if (renderer) {
      renderer(list, section, contentDiv);
    }
  }

  function ensureSectionSkeleton(sections, sectionDataMap) {
    const root = document.getElementById('meta-sections-root');
    if (!root) return;
    root.innerHTML = '';
    sections.forEach(sec => {
      if (!sec.enabled) return;
      // about 特例：只用文案，不渲染列表
      if (sec.id === 'about') {
        const wrap = document.createElement('section');
        wrap.className = 'section';
      wrap.innerHTML = `
          <div class="container is-max-desktop">
            <div id="about">
              <h1 class="title is-3" id="about-title" style="margin-top: 60px;"></h1>
            </div>
            <div id="about-texts" class="about-texts"></div>
          </div>`;
      root.appendChild(wrap);
      return;
      }
      const wrap = document.createElement('section');
      wrap.className = sec.id === 'blogs' ? 'blogs' : 'section';
      wrap.innerHTML = `
        <div class="container is-max-desktop">
          <div id="${sec.id}">
            <h1 class="title is-3" id="${sec.id}-title" style="margin-top: 60px;"></h1>
            <div></div>
          </div>
        </div>`;
      root.appendChild(wrap);
    });
  }

  function updateElement(selector, html) {
    if (html === undefined || html === null) return;
    const element = document.querySelector(selector);
    if (element) element.innerHTML = html;
  }

  function renderTextList(selector, texts) {
    const container = document.querySelector(selector);
    if (!container) return;
    container.innerHTML = '';
    if (!Array.isArray(texts)) return;
    texts.forEach((text, idx) => {
      const p = document.createElement('p');
      p.className = 'text-homepage-1';
      p.innerHTML = text;
      p.dataset.index = idx;
      container.appendChild(p);
    });
  }

  function generateLanguageButtons(webContent) {
    const langDropdown = document.querySelector('#language-dropdown');
    const dropdown = document.querySelector('#language-dropdown-menu');
    const wasOpen = langDropdown && langDropdown.classList.contains('is-active');
    dropdown.innerHTML = '';
    availableLanguages.forEach(lang => {
      const langName = (metaConfig && metaConfig.languageLabels && metaConfig.languageLabels[lang]) || lang;
      const button = document.createElement('a');
      button.className = 'navbar-item';
      button.onclick = (e) => {
        e.stopPropagation(); // 阻止事件冒泡
        switchLanguage(lang);
      };
      button.innerHTML = langName;
      dropdown.appendChild(button);
    });
    // 恢复原先展开状态（避免PC端切换语言后收起）
    if (langDropdown && wasOpen) {
      langDropdown.classList.add('is-active');
    }
  }

  function generateNavFromMeta(sectionDataMap) {
    if (!metaConfig || !Array.isArray(metaConfig.sections)) return;
    const navbarEnd = document.querySelector('.navbar-end');
    if (!navbarEnd) return;
    // 清理旧的导航项（除语言选择）
    const items = Array.from(navbarEnd.querySelectorAll('.navbar-item'));
    items.forEach(el => {
      if (!el.closest('#language-dropdown')) el.remove();
    });
    // 按 sections 生成
    metaConfig.sections.forEach(sec => {
      if (!sec.enabled) return;
      const a = document.createElement('a');
      a.className = 'navbar-item';
      a.id = `navbar-${sec.id}`;
      a.href = `#${sec.id}`;
      const label = (sectionDataMap && sectionDataMap[sec.id] && sectionDataMap[sec.id].nav_label) ? sectionDataMap[sec.id].nav_label : sec.id;
      a.innerHTML = label;
      navbarEnd.insertBefore(a, document.getElementById('language-dropdown'));
    });
  }

  function generateNews(newsList) {
    console.log('Generating news with data:', newsList);
    const newsContainer = document.querySelector('#news');
    if (!newsContainer) {
      console.error('News container not found');
      return;
    }

    // 直接选择 #news 的第二个子元素（内容容器）
    const newsDiv = newsContainer.children[1];
    if (!newsDiv) {
      console.error('News content div not found');
      console.log('News container children:', newsContainer.children);
      return;
    }
    console.log('Found news div:', newsDiv);
    newsDiv.innerHTML = '';
    newsList.forEach(item => {
      const div = document.createElement('div');
      div.style.cssText = 'display: flex; justify-content: flex-start; align-items: center; margin-bottom: 15px;';
      div.innerHTML = `
      <span style="font-weight: bold; margin-right: 50px;">${item.date}</span>
      <span style="font-family: Georgia">${item.content}</span>
    `;
      newsDiv.appendChild(div);
    });
    console.log('News generation completed');
  }

  function generatePublications(publicationsList) {
    console.log('Generating publications with data:', publicationsList);
    const publicationsSection = document.querySelector('#publications');
    if (!publicationsSection) {
      console.error('Publications section not found');
      return;
    }

    // 直接选择 #publications 的第二个子元素（内容容器）
    const contentDiv = publicationsSection.children[1];
    if (!contentDiv) {
      console.error('Publications content div not found');
      console.log('Publications container children:', publicationsSection.children);
      return;
    }
    console.log('Found publications div:', contentDiv);

    // 移除现有 paper-container
    const existingContainers = contentDiv.querySelectorAll('.paper-container');
    existingContainers.forEach(c => c.remove());

    publicationsList.forEach(pub => {
      const paperContainer = document.createElement('div');
      paperContainer.className = 'paper-container';
      paperContainer.innerHTML = `
      <img src="${pub.image}" alt="Overview" class="paper-image">
      <div class="paper-content">
        <h2 class="paper-title">${pub.title}</h2>
        ${pub.conference ? `<p class="paper-conf">${pub.conference}</p>` : ''}
        <p class="paper-authors">${pub.authors}</p>
        <p class="paper-description">${pub.description}</p>
        <p>
          ${pub.links ? pub.links.map(link => `<a href="${link.url}" target="_blank" class="paper-link">[${link.type}]</a>`).join(' ') : ''}
        </p>
      </div>
    `;
      contentDiv.appendChild(paperContainer);
    });
    console.log('Publications generation completed');
  }

  function generateProjects(projectsList) {
    console.log('Generating projects with data:', projectsList);
    const projectsSection = document.querySelector('#projects');
    if (!projectsSection) {
      console.error('Projects section not found');
      return;
    }

    // 直接选择 #projects 的第二个子元素（内容容器）
    const contentDiv = projectsSection.children[1];
    if (!contentDiv) {
      console.error('Projects content div not found');
      console.log('Projects container children:', projectsSection.children);
      return;
    }
    console.log('Found projects div:', contentDiv);

    // 移除现有 paper-container
    const existingContainers = contentDiv.querySelectorAll('.paper-container');
    existingContainers.forEach(c => c.remove());

    projectsList.forEach(proj => {
      const paperContainer = document.createElement('div');
      paperContainer.className = 'paper-container';
      const imageHtml = proj.image ? `<img src="${proj.image}" alt="Overview" class="paper-image">` : '<div class="paper-image" style="background: #f0f0f0; display: flex; align-items: center; justify-content: center; height: 150px;">No Image</div>';
      paperContainer.innerHTML = `
      ${imageHtml}
      <div class="paper-content">
        <h2 class="paper-title" style="display: flex; justify-content: space-between; align-items: center;">
          ${proj.title}
          <span style="margin-left: auto; font-size: 16px;">${proj.date}</span>
        </h2>
        <p class="paper-authors">${proj.authors}</p>
        <p class="paper-description">${proj.description}</p>
        ${proj.links ? `<p>${proj.links.map(link => `<a href="${link.url}" target="_blank" class="paper-link">[${link.type}]</a>`).join(' ')}</p>` : ''}
      </div>
    `;
      contentDiv.appendChild(paperContainer);
    });
    console.log('Projects generation completed');
  }

  function generateBlogs(blogsList) {
    console.log('Generating blogs with data:', blogsList);
    const blogsSection = document.querySelector('#blogs');
    if (!blogsSection) {
      console.error('Blogs section not found');
      return;
    }

    // 直接选择 #blogs 的第二个子元素（内容容器）
    const contentDiv = blogsSection.children[1];
    if (!contentDiv) {
      console.error('Blogs content div not found');
      console.log('Blogs container children:', blogsSection.children);
      return;
    }
    console.log('Found blogs div:', contentDiv);

    // 移除现有 paper-container
    const existingContainers = contentDiv.querySelectorAll('.paper-container');
    existingContainers.forEach(c => c.remove());

    // 可以在这里生成博客内容，如果有的话
    // 目前 blogs.json 是空的
    if (blogsList.length === 0) {
      contentDiv.innerHTML = '<p>No blog posts yet.</p>';
    } else {
      blogsList.forEach(blog => {
        const blogContainer = document.createElement('div');
        blogContainer.className = 'paper-container';

        let linksHtml = '';
        if (blog.links && blog.links.length > 0) {
          linksHtml = blog.links.map(link => `
          <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="paper-link" style="margin-right: 10px;">
            [${link.type}]
          </a>
        `).join('');
        }

        const imageHtml = blog.image
          ? `<img src="${blog.image}" alt="${blog.title}" class="paper-image">`
          : `<div class="paper-image" style="background: #f0f0f0; display: flex; align-items: center; justify-content: center; height: 150px; color: #666;">No Image</div>`;

        blogContainer.innerHTML = `
        ${imageHtml}
        <div class="paper-content">
          <h2 class="paper-title" style="display: flex; justify-content: space-between; align-items: center;">
            ${blog.title}
            <span style="margin-left: auto; font-size: 16px; color: #666;">${blog.date}</span>
          </h2>
          <p class="paper-description blog-description">${blog.content}</p>
          <div>${linksHtml}</div>
        </div>
      `;
        contentDiv.appendChild(blogContainer);
      });
    }
    console.log('Blogs generation completed');
  }

  function generateAcademicService(academicServiceList) {
    console.log('Generating academic service with data:', academicServiceList);
    const academicServiceSection = document.querySelector('#academic-service');
    if (!academicServiceSection) {
      console.error('Academic service section not found');
      return;
    }

    // 直接选择 #academic-service 的第二个子元素（内容容器）
    const contentDiv = academicServiceSection.children[1];
    if (!contentDiv) {
      console.error('Academic service content div not found');
      console.log('Academic service container children:', academicServiceSection.children);
      return;
    }
    console.log('Found academic service div:', contentDiv);

    // 清空现有内容
    contentDiv.innerHTML = '';

    if (academicServiceList.length === 0) {
      contentDiv.innerHTML = '<p>No academic service records yet.</p>';
    } else {
      academicServiceList.forEach(service => {
        const serviceDiv = document.createElement('div');
        serviceDiv.style.cssText = 'display: flex; justify-content: flex-start; align-items: center; margin-bottom: 15px;';
        serviceDiv.innerHTML = `
        <span style="font-weight: bold; margin-right: 50px;">${service.type}</span>
        <span>${service.description}</span>
      `;
        contentDiv.appendChild(serviceDiv);
      });
    }
    console.log('Academic service generation completed');
  }

  function generateCards(cardsList) {
    console.log('Generating cards with data:', cardsList);
    const cardContainer = document.querySelector('.card-container');
    if (!cardContainer) {
      console.error('Card container not found');
      return;
    }

    // 只删除现有的卡片元素，保留按钮
    const existingCards = cardContainer.querySelectorAll('.card');
    existingCards.forEach(card => card.remove());

    if (cardsList.length === 0) {
      console.log('No cards data available');
      return;
    }

    // 只显示前5张卡片（如果有的话）
    const displayCards = cardsList.slice(0, 5);

    displayCards.forEach(card => {
      const cardDiv = document.createElement('div');
      cardDiv.className = 'card';
      cardDiv.innerHTML = `
      <div class="card-title">${card.title}</div>
      <div class="card-description">${card.description}</div>
    `;
      cardContainer.appendChild(cardDiv);
    });

    console.log('Cards generation completed');
  }

  function generateWordCloud(wordcloudList) {
    console.log('Generating word cloud with data:', wordcloudList);
    const tagsContainer = document.querySelector('#tags');
    if (!tagsContainer) {
      console.error('Word cloud tags container not found');
      return;
    }

    // 清空现有标签
    tagsContainer.innerHTML = '';

    if (wordcloudList.length === 0) {
      console.log('No word cloud data available');
      return;
    }

    wordcloudList.forEach(item => {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = '#';
      if (item.title) {
        a.title = item.title;
      }
      a.textContent = item.text;
      li.appendChild(a);
      tagsContainer.appendChild(li);
    });

    // 重新初始化TagCanvas词云
    try {
      if (typeof TagCanvas !== 'undefined') {
        TagCanvas.Start('word-cloud', 'tags', {
          textColour: '#FFFFFF',
          outlineColour: 'rgba(255, 255, 255, 0.5)',
          reverse: true,
          depth: 0.8,
          maxSpeed: 0.01,
          textFont: 'Papyrus, Arial, sans-serif',
          textHeight: 20,
          shuffleTags: true,
          initial: [0.3, 0.3],
          decel: 0.98,
          dragControl: true,
          weight: true,
          shape: 'spiral',
          tooltip: true
        });

        // 添加自定义的自动重新开始功能
        setupWordCloudAutoRestart();
      }
    } catch (e) {
      console.error('TagCanvas re-initialization error:', e);
    }

    console.log('Word cloud generation completed');
  }

  // 设置词云自动重新开始功能
  function setupWordCloudAutoRestart() {
    const canvas = document.getElementById('word-cloud');
    if (!canvas) return;

    let restartTimer = null;
    let isUserInteracting = false;
    let lastInteractionTime = Date.now();
    let dragStartTime = 0;

    // 监听鼠标按下事件
    canvas.addEventListener('mousedown', function (e) {
      isUserInteracting = true;
      dragStartTime = Date.now();
      lastInteractionTime = Date.now();
      console.log('Word cloud interaction started');

      // 清除之前的定时器
      if (restartTimer) {
        clearTimeout(restartTimer);
      }
    });

    // 监听document的鼠标释放事件，确保即使鼠标在区域外释放也能检测到
    document.addEventListener('mouseup', function (e) {
      if (isUserInteracting) {
        isUserInteracting = false;
        lastInteractionTime = Date.now();
        const interactionDuration = Date.now() - dragStartTime;
        console.log('Word cloud interaction ended, duration:', interactionDuration + 'ms');

        // 如果交互时间很短（只是点击），立即重启
        if (interactionDuration < 100) {
          console.log('Short click detected, restarting immediately');
          setTimeout(() => startWordCloudRotation(), 100);
          return;
        }

        // 清除之前的定时器
        if (restartTimer) {
          clearTimeout(restartTimer);
        }

        // 5秒后重新开始转动
        restartTimer = setTimeout(function () {
          const timeSinceLastInteraction = Date.now() - lastInteractionTime;
          if (timeSinceLastInteraction >= 5000 && !isUserInteracting) {
            console.log('Word cloud restarting after 5 seconds of inactivity');
            startWordCloudRotation();
          }
        }, 5000);
      }
    });

    // 监听鼠标移动事件
    canvas.addEventListener('mousemove', function (e) {
      if (isUserInteracting) {
        lastInteractionTime = Date.now();
        // 清除定时器，因为用户正在交互
        if (restartTimer) {
          clearTimeout(restartTimer);
          restartTimer = setTimeout(function () {
            const timeSinceLastInteraction = Date.now() - lastInteractionTime;
            if (timeSinceLastInteraction >= 5000 && !isUserInteracting) {
              console.log('Word cloud restarting after 5 seconds of inactivity');
              startWordCloudRotation();
            }
          }, 5000);
        }
      }
    });

    // 监听鼠标离开事件
    canvas.addEventListener('mouseleave', function () {
      // 鼠标离开时不改变isUserInteracting状态，让document的mouseup事件处理
      console.log('Mouse left word cloud area');
    });

    // 监听鼠标进入事件
    canvas.addEventListener('mouseenter', function () {
      // 如果鼠标进入时还在交互状态（说明鼠标在区域外释放了）
      if (!isUserInteracting && Date.now() - lastInteractionTime < 5000) {
        isUserInteracting = true;
        lastInteractionTime = Date.now();

        // 鼠标重新进入时，清除定时器，因为用户回来了
        if (restartTimer) {
          clearTimeout(restartTimer);
          restartTimer = null;
          console.log('Mouse entered word cloud area, timer cleared');
        } else {
          console.log('Mouse entered word cloud area');
        }
      }
    });
  }

  // 启动词云转动（逐步加速）
  function startWordCloudRotation() {
    if (typeof TagCanvas === 'undefined') return;

    try {
      const canvas = document.getElementById('word-cloud');
      if (canvas) {
        // 尝试重新开始TagCanvas动画
        console.log(canvas.tc)
        if (canvas.tc) {
          // 重新设置动画状态
          canvas.tc.animating = true;
          canvas.tc.active = true;

          // 给所有标签添加随机速度
          if (canvas.tc.taglist && canvas.tc.taglist.length > 0) {
            canvas.tc.taglist.forEach(function (tag) {
              tag.vx = (Math.random() - 0.5) * 0.02;
              tag.vy = (Math.random() - 0.5) * 0.02;
              tag.va = (Math.random() - 0.5) * 0.02;
            });
          }

          // 强制重绘
          if (canvas.tc.Draw) {
            canvas.tc.Draw();
          }
          console.log('Word cloud rotation restarted with velocity reset');
        } else {
          // 如果tc对象不存在，重新初始化
          TagCanvas.Start('word-cloud', 'tags', {
            textColour: '#FFFFFF',
            outlineColour: 'rgba(255, 255, 255, 0.5)',
            reverse: true,
            depth: 0.8,
            maxSpeed: 0.01,
            textFont: 'Papyrus, Arial, sans-serif',
            textHeight: 20,
            shuffleTags: true,
            initial: [0.3, 0.3],
            decel: 0.98,
            dragControl: true,
            weight: true,
            shape: 'spiral',
            tooltip: true
          });
          console.log('Word cloud re-initialized');
        }
      }
    } catch (e) {
      console.error('Error restarting word cloud rotation:', e);
    }
  }

  function switchLanguage(lang) {
    localStorage.setItem('lang', lang);
    // 记录切换前是否展开
    const dropdown = document.querySelector('#language-dropdown');
    const wasOpen = dropdown && dropdown.classList.contains('is-active');
    loadContent(lang).then(() => {
      // 渲染完成后恢复展开状态（桌面端与移动端均根据之前状态恢复）
      const dd = document.querySelector('#language-dropdown');
      if (dd && wasOpen) {
        dd.classList.add('is-active');
      }
      applyBackground(getCurrentSectionId());
    });
  }

  // 布局模式切换功能
  function initializeLayoutMode() {
    const layoutModeToggle = document.getElementById('layout-mode-toggle');

    function updateLayoutButton() {
      if (layoutModeToggle) {
        if (layoutMode === 'single') {
          layoutModeToggle.innerHTML = '<i class="fas fa-layer-group"></i>';
          layoutModeToggle.title = 'Switch to Multi-page Mode';
        } else {
          layoutModeToggle.innerHTML = '<i class="fas fa-file-alt"></i>';
          layoutModeToggle.title = 'Switch to Single-page Mode';
        }
      }
    }

    function toggleLayoutMode() {
      const oldMode = layoutMode;
      layoutMode = 'multi';
      localStorage.setItem('layoutMode', layoutMode);
      updateLayoutButton();

      window.location.href = 'multipage_index.html?page=home';

    }

    if (layoutModeToggle) {
      layoutModeToggle.addEventListener('click', (e) => {
        e.preventDefault();
        toggleLayoutMode();
      });
    }

    updateLayoutButton();
  }

  // 初始化语言dropdown功能
  function initializeLanguageDropdown() {
    const languageLink = document.querySelector('#navbar-language');
    const languageDropdown = document.querySelector('#language-dropdown');

    if (languageLink && languageDropdown) {
      // 初始保持收起
      languageDropdown.classList.remove('is-active');
      languageLink.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        // 切换dropdown的激活状态
        const willOpen = !languageDropdown.classList.contains('is-active');
        if (willOpen) {
          languageDropdown.classList.remove('is-closing');
          languageDropdown.classList.add('is-active');
        } else {
          languageDropdown.classList.add('is-closing');
          setTimeout(() => {
            languageDropdown.classList.remove('is-active');
            languageDropdown.classList.remove('is-closing');
          }, 350);
        }
      });

      // 点击外部关闭dropdown（包含菜单容器）
      document.addEventListener('click', (e) => {
        if (!languageDropdown.contains(e.target)) {
          if (languageDropdown.classList.contains('is-active')) {
            languageDropdown.classList.add('is-closing');
            // 等待动画结束后再移除 is-active 与 is-closing
            setTimeout(() => {
              languageDropdown.classList.remove('is-active');
              languageDropdown.classList.remove('is-closing');
            }, 350);
          }
        }
      });
    }
  }

  // 汉堡菜单：点击外部自动收起
  function initializeHamburgerAutoClose() {
    const burger = document.querySelector('.navbar-burger');
    const menu = document.querySelector('.navbar-menu');

    if (!burger || !menu) return;

    // 点击页面其它区域：带收起动画
    document.addEventListener('click', (e) => {
      if (!menu.contains(e.target) && menu.classList.contains('is-active')) {
        menu.classList.add('is-closing');
        setTimeout(() => {
          menu.classList.remove('is-active');
          menu.classList.remove('is-closing');
          burger.classList.remove('is-active');
        }, 100);
      }
    });
  }

  function initializeNavbarResizeReset() {
    const navbarMenu = document.querySelector('.navbar-menu');
    const navbarBurger = document.querySelector('.navbar-burger');
    if (!navbarMenu || !navbarBurger) return;

    let wasDesktop = window.innerWidth >= 1024;

    function resetState() {
      navbarMenu.classList.remove('is-active', 'is-closing');
      navbarBurger.classList.remove('is-active');
    }

    if (wasDesktop) resetState();

    window.addEventListener('resize', () => {
      const isDesktop = window.innerWidth >= 1024;
      if (isDesktop && !wasDesktop) {
        resetState();
      }
      wasDesktop = isDesktop;
    });
  }

  // 初始化卡片切换功能
  function initializeCardSlider() {
    const cards = document.querySelectorAll('.card');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    let currentIndex = Math.floor(Math.random() * cards.length);

    // Function to show the current card
    function showCard(index) {
      cards.forEach((card, i) => {
        card.classList.remove('active');
        if (i === index) {
          card.classList.add('active');
        }
      });
    }

    // Handle Previous Button
    if (prevBtn) {
      prevBtn.addEventListener('click', () => {
        currentIndex = (currentIndex - 1 + cards.length) % cards.length;
        showCard(currentIndex);
      });
    }

    // Handle Next Button
    if (nextBtn) {
      nextBtn.addEventListener('click', () => {
        currentIndex = (currentIndex + 1) % cards.length;
        showCard(currentIndex);
      });
    }

    // Optionally: Auto switch cards every 5 seconds
    setInterval(() => {
      currentIndex = (currentIndex + 1) % cards.length;
      showCard(currentIndex);
    }, 5000);

    // 显示第一张卡片
    if (cards.length > 0) {
      showCard(currentIndex);
    }
  }

  // 暗夜模式功能
  function initializeDarkMode() {
    const darkModeToggleMobile = document.getElementById('dark-mode-toggle-mobile');
    const body = document.body;

    const isDarkMode = localStorage.getItem('darkMode') === 'true';

    if (isDarkMode) {
      body.classList.add('dark-mode');
      if (darkModeToggleMobile) {
        darkModeToggleMobile.innerHTML = '<i class="fas fa-sun"></i>';
      }
    } else {
      if (darkModeToggleMobile) {
        darkModeToggleMobile.innerHTML = '<i class="fas fa-moon"></i>';
      }
    }

    function toggleDarkMode() {
      const isCurrentlyDark = body.classList.contains('dark-mode');
      if (isCurrentlyDark) {
        body.classList.remove('dark-mode');
        localStorage.setItem('darkMode', 'false');
        if (darkModeToggleMobile) darkModeToggleMobile.innerHTML = '<i class="fas fa-moon"></i>';
      } else {
        body.classList.add('dark-mode');
        localStorage.setItem('darkMode', 'true');
        if (darkModeToggleMobile) darkModeToggleMobile.innerHTML = '<i class="fas fa-sun"></i>';
      }
      applyBackground(getCurrentSectionId());
    }

    if (darkModeToggleMobile) {
      darkModeToggleMobile.addEventListener('click', (e) => {
        e.preventDefault();
        toggleDarkMode();
      });
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    (async () => { await loadMeta(); await loadContent(); })();

    // 检查是否需要滚动到顶部
    const urlParams = new URLSearchParams(window.location.search);
    const shouldScrollToTop = urlParams.get('scroll') === 'top';

    if (shouldScrollToTop) {
      setTimeout(() => {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
        // 清理URL参数
        window.history.replaceState({}, document.title, window.location.pathname);
      }, 100);
    }

    // 初始化语言dropdown功能
    initializeLanguageDropdown();

    // 初始化布局模式功能
    initializeLayoutMode();

    // 初始化暗夜模式功能
    initializeDarkMode();

    // 初始化汉堡菜单外部点击收起
    initializeHamburgerAutoClose();
    initializeNavbarResizeReset();

    // 汉堡菜单功能已由jQuery处理

    // 返回顶部按钮功能
    const backToTopButton = document.getElementById('back-to-top');

    // 滚动监听 - 显示/隐藏返回顶部按钮
    window.addEventListener('scroll', () => {
      if (window.pageYOffset > 300) {
        backToTopButton.classList.add('show');
      } else {
        backToTopButton.classList.remove('show');
      }
    });

    // 点击事件 - 平滑滚动到顶部
    backToTopButton.addEventListener('click', () => {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    });
    applyBackground(getCurrentSectionId());
  });

  window.addEventListener('hashchange', () => {
    applyBackground(getCurrentSectionId());
  });
</script>

</html>
